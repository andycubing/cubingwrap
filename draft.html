<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuber WCA Career Summary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'slate': {
                            950: '#0c1015',
                            900: '#111827',
                            800: '#1f2937',
                            700: '#374151',
                            600: '#4b5563',
                            500: '#6b7280',
                        },
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen bg-slate-900 text-slate-200">

    <!-- Icon Library (Lucide) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
        // Initialize Lucide icons
        const updateIcons = () => { if (typeof lucide !== 'undefined') lucide.createIcons(); };
        window.addEventListener('load', updateIcons);
    </script>
    
    <!-- Main App Container -->
    <div id="app">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <script>
        // --- DATA & CONFIG ---
        const WCA_ID_DEFAULT = '2017KWAN05';
        const APP_ROOT = document.getElementById('app');
        
        // Define all events and their sorting order
        const EVENT_ORDER = [
            "333", "222", "444", "555", "666", "777", 
            "333bf", "333fm", "333oh", "clock", "minx", 
            "pyram", "skewb", "sq1", "444bf", "555bf", "333mbf",
            "333ft", "magic", "mmagic" // Non-official/old events
        ];

        // Custom event info (using a uniform color for tables)
        const EVENT_MAP = {
            "333": { name: "3x3x3", color: "text-yellow-400", bg: "bg-yellow-400" },
            "222": { name: "2x2x2", color: "text-gray-300", bg: "bg-gray-300" },
            "444": { name: "4x4x4", color: "text-green-400", bg: "bg-green-400" },
            "555": { name: "5x5x5", color: "text-red-400", bg: "bg-red-400" },
            "666": { name: "6x6x6", color: "text-red-600", bg: "bg-red-600" },
            "777": { name: "7x7x7", color: "text-blue-500", bg: "bg-blue-500" },
            "333oh": { name: "3x3 OH", color: "text-orange-400", bg: "bg-orange-400" },
            "333fm": { name: "3x3 FMC", color: "text-emerald-400", bg: "bg-emerald-400" },
            "333bf": { name: "3x3 BLD", color: "text-emerald-600", bg: "bg-emerald-600" },
            "333mbf": { name: "3x3 Multi-Blind", color: "text-slate-400", bg: "bg-slate-400" },
            "pyram": { name: "Pyraminx", color: "text-yellow-200", bg: "bg-yellow-200" },
            "minx": { name: "Megaminx", color: "text-pink-400", bg: "bg-pink-400" },
            "skewb": { name: "Skewb", color: "text-orange-300", bg: "bg-orange-300" },
            "sq1": { name: "Square-1", color: "text-blue-300", bg: "bg-blue-300" },
            "clock": { name: "Clock", color: "text-teal-300", bg: "bg-teal-300" },
            "444bf": { name: "4x4 BLD", color: "text-green-600", bg: "bg-green-600" },
            "555bf": { name: "5x5 BLD", color: "text-red-600", bg: "bg-red-600" },
            "333ft": { name: "3x3 Feet", color: "text-gray-600", bg: "bg-gray-600" },
            "magic": { name: "Magic", color: "text-indigo-400", bg: "bg-indigo-400" },
            "mmagic": { name: "Master Magic", color: "text-indigo-600", bg: "bg-indigo-600" },
        };
        
        const getEventInfo = (eventId) => EVENT_MAP[eventId] || { name: eventId, color: "text-gray-400", bg: "bg-gray-400" };
        const ROUND_ORDER = {
            "First round": 1,
            "Combined First round": 1,
            "Second round": 2,
            "Semi Final": 3,
            "Final": 4,
            "Combined Final": 4};
        const getRoundPriority = (roundName) => ROUND_ORDER[roundName] || 99;      
        // --- STATE MANAGEMENT ---
        let wcaId = WCA_ID_DEFAULT;
        let inputWcaId = WCA_ID_DEFAULT;
        let userData = null;
        let historyData = [];
        let loading = false;
        let error = null;
        // selectedYear starts as a string
        let selectedYear = 'All Time';
        let activeTab = 'overview';
        let compMetadata = {};
        let loadingMetadata = false;
        let metadataFetchInProgress = false; 

        // Make setState global to ensure inline onclick handlers work reliably
        window.state = { 
            wcaId, inputWcaId, userData, historyData, loading, error, 
            selectedYear, activeTab, compMetadata, loadingMetadata, metadataFetchInProgress
        };

        window.setState = (newState) => {
            Object.assign(window.state, newState);
            renderApp();
        };

        // --- UTILITY FUNCTIONS ---

        const formatResult = (centiseconds, eventId, type = 'single') => {
            if (centiseconds === -1) return "DNF";
            if (centiseconds === -2) return "DNS";
            if (centiseconds === 0 || centiseconds == null) return "-";

            // 1. Multi-Blind (333mbf) Decoding
            if (eventId === '333mbf') {
                const R = centiseconds;
                const missed = R % 100; 
                const timeInSeconds = Math.floor(R / 100) % 100000; 
                const difference = Math.floor(R / 10000000); 

                const mins = Math.floor(timeInSeconds / 60);
                const secs = timeInSeconds % 60;
                const timeStr = `${mins}:${secs < 10 ? '0' : ''}${secs}`;

                const solved = (99 - difference) + missed;
                const attempted = solved + missed;

                if (solved < 0 || attempted < 0) return R.toString(); 

                return `${solved}/${attempted} ${timeStr}`;
            }

            // 2. Fewest Moves Challenge (333fm)
            if (eventId === '333fm') {
                if (type === 'average' || centiseconds > 1000) {
                    return (centiseconds / 100).toFixed(2);
                }
                return centiseconds.toString();
            }

            // 3. Standard Time Formatting
            let mins = Math.floor(centiseconds / 6000);
            let secs = Math.floor((centiseconds % 6000) / 100);
            let decis = centiseconds % 100;

            let sDecis = decis < 10 ? `0${decis}` : decis;
            let sSecs = secs < 10 && mins > 0 ? `0${secs}` : secs;

            if (mins > 0) return `${mins}:${sSecs}.${sDecis}`;
            return `${secs}.${sDecis}`;
        };

        const extractYearFromId = (compId) => {
            const match = compId.match(/(\d{4})$/);
            return match ? parseInt(match[0], 10) : new Date().getFullYear();
        };

        const processWcaData = (data) => {
            if (!data || !data.results) return [];

            const yearsMap = new Map();

            // Sort competition IDs by date (WCA ID usually includes year and month, but we rely on year here)
            const sortedCompIds = Object.keys(data.results).sort((a, b) => a.localeCompare(b));

            sortedCompIds.forEach((compId) => {
                const eventsData = data.results[compId];
                const year = extractYearFromId(compId);
                
                if (!yearsMap.has(year)) {
                    yearsMap.set(year, {
                        year, // Stored as a number
                        competitions: []
                    });
                }

                const yearEntry = yearsMap.get(year);
                const eventsList = Object.keys(eventsData).filter(e => e !== '333mbo'); // Remove 333mbo
                
                let roundsCount = 0;
                const results = [];
                let solvesCount = 0;
                let attemptsCount = 0;

                Object.entries(eventsData).forEach(([eventId, rounds]) => {
                    if (eventId === '333mbo') return; // Skip 333mbo
                    
                    rounds.forEach(roundData => {
                        roundsCount++;
                        
                        // Calculate Solves/Attempts
                        if (roundData.solves) {
                            roundData.solves.forEach(s => {
                                if (s > 0) attemptsCount++;
                                if (s === -1) attemptsCount++;
                                if (s > 0) solvesCount++;
                            });
                        }

                        results.push({
                            event: eventId,
                            round: roundData.round,
                            place: roundData.position,
                            best: roundData.best,
                            average: roundData.average,
                            format: roundData.format,
                            solves: roundData.solves
                        });
                    });
                });

                yearEntry.competitions.push({
                    id: compId,
                    name: compId,
                    events: eventsList,
                    rounds: roundsCount,
                    solvesCount,
                    attemptsCount,
                    results: results
                });
            });

            return Array.from(yearsMap.values()).sort((a, b) => b.year - a.year);
        };
        
        // --- DATA FETCHING ---

        const fetchCompDetails = async (compIds) => {
            const { compMetadata, metadataFetchInProgress } = window.state;
            
            // Critical check to prevent re-entry
            if (metadataFetchInProgress) return; 

            // IMPORTANT FIX: Check if we have processed it OR if it failed previously
            // We only want to fetch IDs that are NOT in compMetadata at all.
            const missingIds = compIds.filter(id => compMetadata[id] === undefined);
            
            if (missingIds.length === 0) return;

            window.setState({ loadingMetadata: true, metadataFetchInProgress: true });
            
            const chunkSize = 5;
            for (let i = 0; i < missingIds.length; i += chunkSize) {
                const chunk = missingIds.slice(i, i + chunkSize);
                
                await Promise.all(chunk.map(async (id) => {
                    try {
                        let res;
                        // Retry logic
                        for (let attempt = 0; attempt < 2; attempt++) {
                            res = await fetch(`https://raw.githubusercontent.com/robiningelbrecht/wca-rest-api/master/api/competitions/${id}.json`);
                            if (res.ok) break;
                            await new Promise(resolve => setTimeout(resolve, 500 * (attempt + 1))); 
                        }
                        
                        if (res && res.ok) {
                            const data = await res.json();
                            compMetadata[id] = data;
                        } else {
                             // CRITICAL FIX: If fetch fails, mark as error so we don't try again forever
                             compMetadata[id] = { name: id, country: 'Unknown', city: '', error: true };
                             console.warn(`Marking ${id} as failed to prevent infinite loop.`);
                        }
                    } catch (e) {
                        // CRITICAL FIX: Catch network errors and mark as failed
                        compMetadata[id] = { name: id, country: 'Unknown', city: '', error: true };
                        console.warn(`Failed to fetch metadata for ${id}`, e);
                    }
                }));
                // Batch update the state after processing a chunk
                window.setState({ compMetadata: { ...compMetadata } });
            }
            
            // Final state update
            window.setState({ loadingMetadata: false, metadataFetchInProgress: false });
        };

        const fetchData = async (id) => {
            window.setState({ loading: true, error: null, compMetadata: {} });
            try {
                const response = await fetch(`https://raw.githubusercontent.com/robiningelbrecht/wca-rest-api/master/api/persons/${id}.json`);
                if (!response.ok) throw new Error("Competitor not found");
                const data = await response.json();
                
                window.setState({
                    userData: {
                        name: data.name,
                        wcaId: data.id,
                        country: data.country,
                        avatar: `https://flagcdn.com/w160/${data.country.toLowerCase()}.png`
                    },
                    historyData: processWcaData(data),
                    selectedYear: 'All Time'
                });
            } catch (err) {
                window.setState({ error: err.message, userData: null, historyData: [] });
            } finally {
                window.setState({ loading: false });
            }
        };

        window.handleSearch = (e) => {
            e.preventDefault();
            const id = window.state.inputWcaId.trim().toUpperCase();
            if (id) {
                window.setState({ wcaId: id });
                fetchData(id);
            }
        };

        // --- STATS CALCULATION ---
        
        const calculateYearMedals = (comps) => {
            let medals = { gold: 0, silver: 0, bronze: 0 };
            comps.forEach(comp => {
                comp.results.forEach(res => {
                    if (res.round === "Final" && res.place <= 3 && res.best > 0) {
                        if (res.place === 1) medals.gold++;
                        else if (res.place === 2) medals.silver++;
                        else if (res.place === 3) medals.bronze++;
                    }
                });
            });
            return medals;
        };
        
        // Helper to generate the progression timeline
        const calculateTimelineAndCounts = (historyData, compMetadata, selectedYear = 'All Time') => {
          const isAllTime = selectedYear === 'All Time';
          const maxYear = isAllTime ? Infinity : parseInt(selectedYear);
      
          let allComps = historyData
              .filter(y => y.year <= maxYear)
              .flatMap(y => y.competitions);
      
          allComps.sort((a, b) => {
              const dateA = compMetadata[a.id]?.date?.from || '1900-01-01';
              const dateB = compMetadata[b.id]?.date?.from || '1900-01-01';
              return dateA.localeCompare(dateB) || a.id.localeCompare(b.id);
          });
      
          const timeline = {};
          const currentBest = {};
          EVENT_ORDER.forEach(e => {
              timeline[e] = [];
              currentBest[e] = { single: Infinity, average: Infinity };
          });
      
          allComps.forEach(comp => {
              const date = compMetadata[comp.id]?.date?.from || "";
              const compName = compMetadata[comp.id]?.name || comp.id;
      
              const sortedResults = [...comp.results].sort((a, b) =>
                  getRoundPriority(a.round) - getRoundPriority(b.round)
              );
      
              sortedResults.forEach(res => {
                  const eventId = res.event;
      
                  let improved = false;
                  const entries = [];
      
                  if (res.best > 0 && res.best <= currentBest[eventId].single) {
                      currentBest[eventId].single = res.best;
                      improved = true;
                      entries.push({
                          type: 'Single',
                          formattedResult: formatResult(res.best, eventId, 'single'),
                          details: ''
                      });
                  }
      
                  if (eventId !== '333mbf' && res.average > 0 && res.average <= currentBest[eventId].average) {
                      currentBest[eventId].average = res.average;
                      improved = true;
                      const details = res.solves ? '(' + res.solves
                          .filter(s => s !== 0)
                          .map(s => s === -1 ? 'DNF' : s === -2 ? 'DNS' : formatResult(s, eventId))
                          .join(', ') + ')' : '';
                      entries.push({
                          type: 'Average',
                          formattedResult: formatResult(res.average, eventId, 'average'),
                          details
                      });
                  }
      
                  if (improved) {
                      entries.forEach(entry => {
                          timeline[eventId].push({
                              ...entry,
                              compName, date, round: res.round
                          });
                      });
                  }
              });
          });
      
          Object.keys(timeline).forEach(k => timeline[k].length === 0 && delete timeline[k]);
      
          return { timeline };
      };



        const calculateStats = (state) => {
            const { selectedYear, historyData, compMetadata, userData } = state;
            const isAllTime = selectedYear === 'All Time';
        
            // Determine which competitions to include
            const relevantYears = isAllTime 
                ? historyData 
                : historyData.filter(y => y.year <= parseInt(selectedYear));
            
            const relevantComps = relevantYears.flatMap(y => y.competitions);
        
            // Rest of your existing code (medals, countries, etc.) stays the same...
            // ... (keep everything you already have for medals, comps, etc.)
        
            let totalComps = relevantComps.length;
            let totalSolves = 0;
            let totalAttempts = 0;
            let uniqueCountries = new Set(), overseasCount = 0;
            let medals = { gold: 0, silver: 0, bronze: 0 };
            let medalStats = {};
            let sb = { single: {}, average: {} };
            let pb = { single: {}, average: {} };
            const allEventsSet = new Set();
        
            const updateBest = (storage, event, result, compName) => {
                if (result > 0 && (!storage[event] || result < storage[event].value)) {
                    storage[event] = { value: result, comp: compName };
                }
            };
        
            // Historical PBs up to selected year
            [...historyData].sort((a,b) => a.year - b.year).forEach(yData => {
                if (!isAllTime && yData.year > parseInt(selectedYear)) return;
                yData.competitions.forEach(c => {
                    c.results.forEach(r => {
                        updateBest(pb.single, r.event, r.best, c.name);
                        if (r.event !== '333mbf') updateBest(pb.average, r.event, r.average, c.name);
                    });
                });
            });
        
            // Current year stats
            relevantComps.forEach(comp => {
                totalSolves += comp.solvesCount;
                totalAttempts += comp.attemptsCount;
                comp.events.forEach(e => allEventsSet.add(e));
        
                const meta = compMetadata[comp.id];
                if (meta && !meta.error) {
                    uniqueCountries.add(meta.country);
                    if (userData?.country && meta.country !== userData.country) overseasCount++;
                }
        
                comp.results.forEach(res => {
                    if (res.round === "Final" && res.place <= 3 && res.best > 0) {
                        if (!medalStats[res.event]) medalStats[res.event] = { gold: 0, silver: 0, bronze: 0, total: 0 };
                        if (res.place === 1) { medals.gold++; medalStats[res.event].gold++; }
                        else if (res.place === 2) { medals.silver++; medalStats[res.event].silver++; }
                        else if (res.place === 3) { medals.bronze++; medalStats[res.event].bronze++; }
                        medalStats[res.event].total++;
                    }
                    updateBest(sb.single, res.event, res.best, comp.name);
                    if (res.event !== '333mbf') updateBest(sb.average, res.event, res.average, comp.name);
                });
            });
        
            // THIS IS NEW: Calculate solveCounts and attempts only from relevant competitions
            const yearSolveCounts = {};
            const yearAttemptCounts = {};
            EVENT_ORDER.forEach(e => {
                yearSolveCounts[e] = 0;
                yearAttemptCounts[e] = 0;
            });
        
            relevantComps.forEach(comp => {
                comp.results.forEach(res => {
                    if (res.solves) {
                        res.solves.forEach(s => {
                            if (s > 0) yearSolveCounts[res.event]++;
                            if (s !== 0) yearAttemptCounts[res.event]++; // DNF/DNS = attempt
                        });
                    }
                });
            });
        
            // Use the correct timeline function with year filtering
            const { timeline } = calculateTimelineAndCounts(historyData, compMetadata, selectedYear);
        
            return {
                totalComps, totalSolves, totalAttempts,
                uniqueCountries: uniqueCountries.size, overseasCount,
                uniqueEvents: allEventsSet.size,
                medals, medalStats, sb, pb,
                timeline,
                solveCounts: yearSolveCounts,        // filtered!
                attemptCounts: yearAttemptCounts     // filtered!
            };
        };


        // --- RENDERING COMPONENTS ---

        // Trend Indicator HTML
        const TrendIndicator = (current, previous) => {
            if (previous === undefined || previous === null || current === null || isNaN(current) || isNaN(previous)) {
                 return `<span class="text-slate-500 ml-2 text-xs">-</span>`;
            }
            
            if (previous === 0 && current > 0) {
                 return `<span class="text-green-400 ml-2 text-xs font-medium flex items-center">
                            <i data-lucide="chevrons-up" class="w-3 h-3 mr-0.5"></i>
                            ${current}
                            <span class="opacity-70 ml-0.5">(New)</span>
                        </span>`;
            } else if (previous === 0 && current === 0) {
                return `<span class="text-slate-500 ml-2 text-xs"><i data-lucide="minus" class="inline w-3 h-3"></i></span>`;
            } else if (current === 0) {
                 return `<span class="text-red-400 ml-2 text-xs font-medium flex items-center">
                            <i data-lucide="arrow-down-right" class="w-3 h-3 mr-0.5"></i>
                            ${previous}
                            <span class="opacity-70 ml-0.5">(-100%)</span>
                        </span>`;
            }
            
            const diff = current - previous;
            if (diff === 0) return `<span class="text-slate-500 ml-2 text-xs"><i data-lucide="minus" class="inline w-3 h-3"></i></span>`;

            const percentage = ((diff / previous) * 100).toFixed(0);
            const isPositive = diff > 0;
            
            const ColorClass = isPositive ? "text-green-400" : "text-red-400";
            const IconName = isPositive ? "arrow-up-right" : "arrow-down-right";

            return `
                <span class="ml-2 text-xs font-medium flex items-center ${ColorClass}">
                    <i data-lucide="${IconName}" class="w-3 h-3 mr-0.5"></i>
                    ${Math.abs(diff)}
                    <span class="opacity-70 ml-0.5">(${percentage}%)</span>
                </span>
            `;
        };

        const StatCard = ({ title, value, subtext, icon, colorClass, trendHtml }) => `
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg flex items-center space-x-4 relative overflow-hidden">
                <div class="p-4 rounded-full bg-slate-700/50 ${colorClass} z-10">
                    <i data-lucide="${icon}" class="w-7 h-7"></i>
                </div>
                <div class="z-10 flex-1">
                    <h3 class="text-slate-400 text-sm font-medium uppercase tracking-wider">${title}</h3>
                    <div class="flex items-baseline">
                        <div class="text-3xl font-bold text-white mt-1">${value}</div>
                        ${trendHtml || ''}
                    </div>
                    ${subtext ? `<div class="text-slate-500 text-xs mt-1">${subtext}</div>` : ''}
                </div>
            </div>
        `;

        const CompetitionItem = (comp) => {
            const metadata = window.state.compMetadata[comp.id] || null;
            const compName = metadata?.name || comp.id;
            const link = `https://www.worldcubeassociation.org/competitions/${comp.id}`;
            
            const medalResults = comp.results
                .filter(r => r.place <= 3 && r.round === "Final" && r.best > 0);
            
            const medalHtml = medalResults.map((res) => {
                const eventInfo = getEventInfo(res.event);
                const placeClass = res.place === 1 ? 'border-yellow-500/30' : res.place === 2 ? 'border-gray-400/30' : 'border-amber-700/30';
                const iconHtml = res.place === 1 
                    ? '<i data-lucide="award" class="w-3 h-3 text-yellow-400 mr-1"></i>' 
                    : res.place === 2 
                    ? '<i data-lucide="award" class="w-3 h-3 text-gray-400 mr-1"></i>'
                    : '<i data-lucide="award" class="w-3 h-3 text-amber-700 mr-1"></i>';

                const result = formatResult(res.average > 0 ? res.average : res.best, res.event, res.average > 0 ? 'average' : 'single');

                return `
                    <div class="text-xs p-2 rounded bg-slate-800/50 border ${placeClass} flex items-center justify-between">
                        <span class="font-semibold text-slate-300">${eventInfo.name}</span>
                        <div class="flex items-center">
                            ${iconHtml}
                            <span class="font-mono">${result}</span>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="group relative border-l-2 border-slate-700 pl-6 pb-8 last:pb-0 hover:border-indigo-500 transition-colors">
                    <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-800 border-2 border-slate-600 group-hover:border-indigo-500 group-hover:scale-110 transition-all"></div>
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-2">
                        <div>
                            <div class="flex items-center gap-2">
                                <h4 class="text-lg font-bold text-white group-hover:text-indigo-400 transition-colors">
                                    <a href="${link}" target="_blank" rel="noreferrer" class="flex items-center gap-2 hover:underline">
                                        ${compName}
                                        <i data-lucide="external-link" class="w-3.5 h-3.5 opacity-50"></i>
                                    </a>
                                </h4>
                            </div>
                            <div class="text-sm text-slate-400 flex flex-wrap items-center gap-3 mt-1">
                                ${metadata?.date ? `<span class="flex items-center gap-1"><i data-lucide="calendar" class="w-3.5 h-3.5"></i> ${metadata.date.from}</span>` : `<span class="flex items-center gap-1"><i data-lucide="hash" class="w-3.5 h-3.5"></i> ${comp.id}</span>`}
                                
                                ${metadata?.city ? `<span class="flex items-center gap-1"><i data-lucide="map-pin" class="w-3.5 h-3.5"></i> ${metadata.city}, ${metadata.country}</span>` : ''}
                            </div>
                        </div>
                        <div class="mt-2 sm:mt-0 flex gap-2">
                            <span class="text-xs font-mono bg-slate-800 px-2 py-1 rounded text-slate-300 border border-slate-700">
                                ${comp.events.length} Events
                            </span>
                            <span class="text-xs font-mono bg-slate-800 px-2 py-1 rounded text-slate-300 border border-slate-700">
                                ${comp.solvesCount} Solves
                            </span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-3">
                        ${medalHtml}
                    </div>
                </div>
            `;
        };

        const MedalTable = (medalStats) => {
            const rows = Object.entries(medalStats)
                .sort(([a], [b]) => EVENT_ORDER.indexOf(a) - EVENT_ORDER.indexOf(b))
                .filter(([, stats]) => stats.total > 0)
                .map(([event, stats]) => {
                    const eventInfo = getEventInfo(event);
                    return `
                        <tr class="hover:bg-slate-800/50 transition-colors">
                            <td class="px-4 py-3 font-medium text-white flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full ${eventInfo.bg}"></div>
                                ${eventInfo.name}
                            </td>
                            <td class="px-4 py-3 text-center font-bold text-yellow-500">${stats.gold || "-"}</td>
                            <td class="px-4 py-3 text-center font-bold text-gray-400">${stats.silver || "-"}</td>
                            <td class="px-4 py-3 text-center font-bold text-amber-700">${stats.bronze || "-"}</td>
                            <td class="px-4 py-3 text-right font-bold text-white">${stats.total}</td>
                        </tr>
                    `;
                }).join('');

            return `
                <div class="overflow-hidden rounded-xl border border-slate-800">
                    <table class="w-full text-left bg-slate-900">
                        <thead class="bg-slate-950 text-slate-400 text-xs uppercase font-semibold">
                            <tr>
                                <th class="px-4 py-3">Event</th>
                                <th class="px-4 py-3 text-center text-yellow-500">Gold</th>
                                <th class="px-4 py-3 text-center text-gray-400">Silver</th>
                                <th class="px-4 py-3 text-center text-amber-700">Bronze</th>
                                <th class="px-4 py-3 text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800 text-sm">
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        };
        
        const RecordTable = (records, title, isAllTime, type, historicalPB = {}) => {
            if (!records || !records.single) return '';
            
            const events = Object.keys(records.single);
            const sortedEvents = events.sort((a, b) => EVENT_ORDER.indexOf(a) - EVENT_ORDER.indexOf(b));

            const rows = sortedEvents.map((event) => {
                const recordSingle = records.single[event];
                const recordAvg = records.average[event];
                
                const historicalPBSingle = historicalPB.single?.[event]?.value || null;
                const historicalPBAvg = historicalPB.average?.[event]?.value || null;

                const isNewPBSingle = !isAllTime && historicalPBSingle !== null && recordSingle && recordSingle.value <= historicalPBSingle;
                const isNewPBAvg = !isAllTime && historicalPBAvg !== null && recordAvg && recordAvg.value <= historicalPBAvg;


                return `
                    <tr class="hover:bg-slate-800/50 transition-colors">
                        <td class="px-6 py-4 font-medium text-white flex items-center gap-2">
                            ${getEventInfo(event).name}
                        </td>
                        
                        <td class="px-6 py-4 border-r border-slate-800/50">
                            <div class="font-mono text-indigo-300 font-bold">
                                ${recordSingle ? formatResult(recordSingle.value, event, 'single') : "-"}
                                ${isNewPBSingle ? '<i data-lucide="award" class="w-3 h-3 text-yellow-400 ml-1"></i>' : ''}
                            </div>
                            <div class="text-xs text-slate-500 truncate max-w-[250px]">${recordSingle?.comp || ""}</div>
                        </td>

                        <td class="px-6 py-4">
                            <div class="font-mono text-white font-bold">
                                ${recordAvg ? formatResult(recordAvg.value, event, 'average') : "-"}
                                ${isNewPBAvg ? '<i data-lucide="award" class="w-3 h-3 text-yellow-400 ml-1"></i>' : ''}
                            </div>
                            <div class="text-xs text-slate-500 truncate max-w-[250px]">${recordAvg?.comp || ""}</div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            if (rows === '') {
                return `
                    <div class="p-12 text-center text-slate-500 bg-slate-900 border border-slate-800 rounded-xl border-dashed">
                       <i data-lucide="alert-circle" class="mx-auto mb-2 opacity-20 w-12 h-12"></i>
                       No records found in this selection.
                    </div>
                `;
            }


            return `
                <div class="mb-10">
                    <h4 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        ${title}
                    </h4>
                    <div class="overflow-x-auto rounded-xl border border-slate-800">
                        <table class="w-full text-left bg-slate-900">
                            <thead class="bg-slate-950 text-slate-400 text-xs uppercase font-semibold">
                                <tr>
                                    <th class="px-6 py-4">Event</th>
                                    <th class="px-6 py-4 text-indigo-300">Single</th>
                                    <th class="px-6 py-4 text-white">Average</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-800">
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        const SolveCountTable = (solveCounts, totalSolves, totalAttempts) => {
            const items = Object.entries(solveCounts)
                .sort(([a], [b]) => EVENT_ORDER.indexOf(a) - EVENT_ORDER.indexOf(b))
                .filter(([, c]) => c > 0)
                .map(([event, count]) => {
                    const e = getEventInfo(event);
                    return `
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex items-center gap-3 cursor-pointer hover:border-indigo-500 transition"
                             onclick="document.getElementById('event-${event}').scrollIntoView({behavior:'smooth', block:'center'})">
                            <div class="p-2 rounded-full ${e.bg}">
                                <i data-lucide="cuboid" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <div class="text-slate-400 text-xs uppercase font-bold">${e.name}</div>
                                <div class="text-xl font-mono font-bold text-white">${count.toLocaleString()}</div>
                            </div>
                        </div>`;
                }).join('');
        
            const successRate = totalAttempts > 0 ? ((totalSolves / totalAttempts) * 100).toFixed(1) : 0;
        
            return `
                <div class="mb-12">
                    
        
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                        ${items}
                    </div>
                </div>`;
        };
        
        const TimelineView = (timeline) => {
            if (Object.keys(timeline).length === 0) {
                return `<div class="text-center py-20 text-slate-500">No record history in this period.</div>`;
            }
        
            const sections = Object.keys(timeline)
                .sort((a, b) => EVENT_ORDER.indexOf(a) - EVENT_ORDER.indexOf(b))
                .map(event => {
                    const i = getEventInfo(event);
                    const records = [...timeline[event]].reverse(); // newest first
        
                    const rows = records.map(rec => `
                        <tr class="hover:bg-slate-800/50 border-l-2 ${rec.type === 'Average' ? 'border-indigo-500' : 'border-emerald-500'}">
                            <td class="px-6 py-4 text-sm text-slate-300 w-32">${rec.date || 'â€”'}</td>
                            <td class="px-6 py-4 text-white font-medium max-w-xs truncate">
                                ${rec.compName}
                                <div class="text-xs text-slate-500 mt-1">${rec.round}</div>
                            </td>
                            <td class="px-6 py-4 w-28 text-center">
                                <span class="px-3 py-1 rounded text-xs font-bold ${rec.type === 'Average' ? 'bg-indigo-900/60 text-indigo-300' : 'bg-emerald-900/60 text-emerald-300'}">
                                    ${rec.type}
                                </span>
                            </td>
                            <td class="px-6 py-4 font-mono font-bold text-white text-center w-40">
                                ${rec.formattedResult}
                                ${rec.isTied ? '<span class="ml-2 text-amber-400 text-xs text-center">=PB</span>' : ''}
                                ${rec.details ? `<div class="text-xs text-slate-500 mt-1 font-normal text-center">${rec.details}</div>` : ''}
                            </td>
                        </tr>`).join('');
        
                    return `
                        <div id="event-${event}" class="w-full max-w-5xl mx-auto mb-16 last:mb-0">
                            <h4 class="text-xl font-bold text-white mb-6 flex items-center gap-3 border-b border-slate-700 pb-4">
                                <div class="w-4 h-4 rounded-full ${i.bg}"></div>
                                ${i.name}
                                <span class="text-slate-400 text-sm font-normal">(${records.length} record${records.length > 1 ? 's' : ''})</span>
                            </h4>
        
                            <div class="w-full overflow-x-auto rounded-xl border border-slate-800">
                                <table class="w-full table-fixed">
                                    <thead class="bg-slate-950 text-slate-400 text-xs uppercase tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4 text-left w-40 text-center">Date</th>
                                            <th class="px-6 py-4 text-left text-center">Competition</th>
                                            <th class="px-6 py-4 text-left w-28 text-center">Type</th>
                                            <th class="px-6 py-4 text-left w-100 text-center">Result</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-800">
                                        ${rows}
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                }).join('');
        
            return `
                <div id="record-timeline" class="w-full mt-8">
                    ${sections}
                </div>`;
        };

        // --- MAIN RENDER FUNCTION ---
        const renderApp = () => {
            const { userData, loading, error, historyData, selectedYear, activeTab, compMetadata, loadingMetadata } = window.state;
            
            const isAllTime = selectedYear === 'All Time';
            
            const relevantComps = isAllTime
                ? historyData.flatMap(h => h.competitions)
                : historyData.find(d => String(d.year) === selectedYear)?.competitions || [];
            
            const stats = calculateStats(window.state);
            
            // Logic to trigger metadata fetch ONLY if needed and not already in progress
            if (!loading && !error && !window.state.metadataFetchInProgress) {
                if (relevantComps.length > 0) {
                    const ids = relevantComps.map(c => c.id);
                    // Pass the list of IDs needed for the current selection
                    fetchCompDetails(ids);
                }
            }
            
            const currentTotalMedals = stats.medals.gold + stats.medals.silver + stats.medals.bronze;
            const prevTotalMedals = stats.prevStats?.medals ? stats.prevStats.medals.gold + stats.prevStats.medals.silver + stats.prevStats.medals.bronze : null;


            const appHtml = `
                <!-- Navbar -->
                <header class="bg-slate-950 border-b border-slate-800 sticky top-0 z-20">
                    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between gap-4">
                        <div class="flex items-center gap-3 shrink-0">
                            <div class="bg-indigo-600 p-2 rounded-lg">
                                <i data-lucide="cuboid" class="text-white w-5 h-5"></i>
                            </div>
                            <h1 class="text-xl font-bold hidden sm:block bg-gradient-to-r from-white to-slate-400 bg-clip-text text-transparent">
                                CuberWCASummary
                            </h1>
                        </div>

                        <form id="searchForm" class="flex-1 max-w-md relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 w-4 h-4"></i>
                            <input 
                                type="text" 
                                id="wcaSearchInput"
                                placeholder="Enter WCA ID (e.g., 2017KWAN05)"
                                class="w-full bg-slate-900 border border-slate-700 rounded-full py-2 pl-10 pr-4 text-sm text-white placeholder:text-slate-600 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all"
                                value="${window.state.inputWcaId}"
                            />
                        </form>
                    </div>
                </header>

                <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

                    ${loading ? `
                        <div class="flex flex-col items-center justify-center py-20 text-indigo-400">
                            <i data-lucide="loader-2" class="animate-spin mb-4 w-12 h-12"></i>
                            <p>Fetching WCA Data...</p>
                        </div>
                    ` : error ? `
                        <div class="flex flex-col items-center justify-center py-20 text-red-400">
                            <i data-lucide="alert-circle" class="mb-4 w-12 h-12"></i>
                            <p class="text-lg font-bold">Error Loading Data</p>
                            <p class="text-sm opacity-80">${error}</p>
                            <p class="text-xs mt-4 text-slate-500">Check WCA ID.</p>
                        </div>
                    ` : !userData ? `
                        <div class="text-center py-20 text-slate-500">
                            <p>No data available. Use the search bar to load a WCA ID.</p>
                        </div>
                    ` : `
                        <!-- Year Selector -->
                        <div class="flex overflow-x-auto pb-4 mb-6 gap-2 no-scrollbar border-b border-slate-800/50">
                            <button
                                onclick="window.setState({ selectedYear: 'All Time' })"
                                class="px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all border ${
                                selectedYear === 'All Time'
                                    ? 'bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/20' 
                                    : 'bg-slate-800 text-slate-400 border-slate-700 hover:text-white hover:border-slate-600'
                                }"
                            >
                                All Time
                            </button>
                            ${historyData.map(h => `
                            <button
                                onclick="window.setState({ selectedYear: '${h.year}' })"
                                class="px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all border ${
                                selectedYear === String(h.year)
                                    ? 'bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/20' 
                                    : 'bg-slate-800 text-slate-400 border-slate-700 hover:text-white hover:border-slate-600'
                                }"
                            >
                                ${h.year}
                            </button>
                            `).join('')}
                        </div>

                        <!-- Profile Header -->
                        <div class="flex flex-col md:flex-row items-center md:items-start gap-6 mb-10">
                            <img src="https://flagcdn.com/w160/${userData.country.toLowerCase()}.png" alt="${userData.country} Flag" 
                                class="w-20 h-20 rounded-full border-4 border-slate-800 shadow-xl bg-slate-700 object-cover" 
                                onerror="this.onerror=null; this.src='https://placehold.co/80x80/1f2937/6b7280?text=${userData.country}';"
                            />
                            <div class="text-center md:text-left flex-1">
                                <h2 class="text-3xl font-bold text-white">${userData.name}</h2>
                                <div class="flex items-center justify-center md:justify-start gap-3 mt-2 text-slate-400">
                                <span class="flex items-center gap-1 text-sm bg-slate-800 px-2 py-0.5 rounded border border-slate-700">
                                    <i data-lucide="hash" class="w-3 h-3"></i> ${userData.wcaId}
                                </span>
                                <span class="flex items-center gap-1 text-sm bg-slate-800 px-2 py-0.5 rounded border border-slate-700">
                                    <i data-lucide="globe" class="w-3 h-3"></i> ${userData.country}
                                </span>
                                </div>
                                <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 bg-slate-900/50 p-4 rounded-lg border border-slate-800/50">
                                    <div class="text-center md:text-left">
                                        <div class="text-xs text-slate-500 uppercase">Total Attempts</div>
                                        <div class="text-white font-mono font-bold">${stats.totalAttempts}</div>
                                    </div>
                                    <div class="text-center md:text-left">
                                        <div class="text-xs text-slate-500 uppercase">Success Rate</div>
                                        <div class="text-indigo-400 font-mono font-bold">
                                            ${stats.totalAttempts > 0 ? ((stats.totalSolves / stats.totalAttempts) * 100).toFixed(1) : 0}%
                                        </div>
                                    </div>
                                    <div class="text-center md:text-left">
                                        <div class="text-xs text-slate-500 uppercase">Countries Visited</div>
                                        <div class="text-white font-mono font-bold flex items-center justify-center md:justify-start gap-2">
                                            ${stats.uniqueCountries} 
                                            ${loadingMetadata ? `<i data-lucide="loader-2" class="animate-spin w-2.5 h-2.5"></i>` : ''}
                                            ${TrendIndicator(stats.uniqueCountries, stats.prevStats?.countries)}
                                        </div>
                                    </div>
                                    <div class="text-center md:text-left">
                                        <div class="text-xs text-slate-500 uppercase">Overseas Comps</div>
                                        <div class="text-white font-mono font-bold flex items-center justify-center md:justify-start gap-2">
                                            ${stats.overseasCount}
                                            ${TrendIndicator(stats.overseasCount, stats.prevStats?.overseas)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Overview Grid -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                            ${StatCard({ 
                                title: "Competitions", 
                                value: stats.totalComps, 
                                trendHtml: TrendIndicator(stats.totalComps, stats.prevStats?.comps),
                                icon: "calendar", 
                                colorClass: "text-blue-400 bg-blue-400/10" 
                            })}
                            ${StatCard({ 
                                title: "Total Solves", 
                                value: stats.totalSolves,
                                trendHtml: TrendIndicator(stats.totalSolves, stats.prevStats?.solves), 
                                icon: "activity", 
                                colorClass: "text-emerald-400 bg-emerald-400/10" 
                            })}
                            ${StatCard({ 
                                title: "Unique Events", 
                                value: stats.uniqueEvents,
                                trendHtml: '',
                                icon: "cuboid", 
                                colorClass: "text-purple-400 bg-purple-400/10" 
                            })}
                            ${StatCard({ 
                                title: "Total Medals", 
                                value: currentTotalMedals, 
                                subtext: `${stats.medals.gold} Gold, ${stats.medals.silver} Silver, ${stats.medals.bronze} Bronze`,
                                trendHtml: TrendIndicator(currentTotalMedals, prevTotalMedals),
                                icon: "trophy", 
                                colorClass: "text-yellow-400 bg-yellow-400/10" 
                            })}
                        </div>

                        <!-- Tab Navigation -->
                        <div class="border-b border-slate-800 mb-8">
                            <nav class="flex space-x-8">
                                ${['overview', 'competitions', 'records', 'solves'].map((tab) => `
                                    <button
                                        onclick="window.setState({ activeTab: '${tab}' })"
                                        class="pb-4 text-sm font-medium border-b-2 transition-colors capitalize ${
                                            activeTab === tab 
                                                ? 'border-indigo-500 text-indigo-400' 
                                                : 'border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-700'
                                        }"
                                    >
                                        ${tab}
                                    </button>
                                `).join('')}
                            </nav>
                        </div>

                        <!-- Tab Content -->
                        <div class="animate-fade-in-up">
                            ${activeTab === 'overview' ? `
                                <div>
                                    <h3 class="text-xl font-bold text-white flex items-center gap-2 mb-6">
                                        <i data-lucide="medal" class="text-indigo-400 w-5 h-5"></i> Medal Breakdown
                                    </h3>
                                    ${Object.keys(stats.medalStats).length > 0 ? MedalTable(stats.medalStats) : `
                                        <div class="p-12 text-center text-slate-500 bg-slate-900 border border-slate-800 rounded-xl border-dashed">
                                            <i data-lucide="trophy" class="mx-auto mb-2 opacity-20 w-12 h-12"></i>
                                            No podiums found in this selection.
                                        </div>
                                    `}
                                </div>
                            ` : activeTab === 'competitions' ? `
                                <div class="space-y-6">
                                    <div class="flex justify-between items-center">
                                        <h3 class="text-xl font-bold text-white">Competition Timeline</h3>
                                        ${loadingMetadata ? `<span class="text-xs text-indigo-400 flex items-center gap-1"><i data-lucide="loader-2" class="animate-spin w-3 h-3"></i> Loading Locations...</span>` : ''}
                                    </div>
                                    
                                    <div class="bg-slate-950 p-6 rounded-xl border border-slate-800">
                                        ${relevantComps.length > 0 ? relevantComps
                                          .sort((a, b) => {
                                              const dateA = window.state.compMetadata[a.id]?.date?.from || a.id;
                                              const dateB = window.state.compMetadata[b.id]?.date?.from || b.id;
                                              return dateB.localeCompare(dateA); 
                                          })
                                          .map(comp => CompetitionItem(comp)).join('') 
                                        : `
                                            <div class="p-12 text-center text-slate-500 bg-slate-900 border border-slate-800 rounded-xl border-dashed">
                                                <i data-lucide="calendar" class="mx-auto mb-2 opacity-20 w-12 h-12"></i>
                                                No competitions found in this year.
                                            </div>
                                        `}
                                    </div>
                                </div>
                            ` : activeTab === 'records' ? `
                                <div>
                                    <h3 class="text-2xl font-bold text-white mb-8 flex items-center gap-2">
                                        <i data-lucide="timer" class="text-indigo-400 w-6 h-6"></i> Personal Records
                                    </h3>
                                    
                                    ${!stats.totalComps ? `
                                        <div class="p-12 text-center text-slate-500 bg-slate-900 border border-slate-800 rounded-xl border-dashed">
                                            <i data-lucide="alert-circle" class="mx-auto mb-2 opacity-20 w-12 h-12"></i>
                                            No competition data for this period.
                                        </div>
                                    ` : selectedYear === 'All Time' ? `
                                        ${RecordTable(stats.pb, "All-Time Personal Records (PRs)", true, 'pb')}
                                    ` : `
                                        ${RecordTable(stats.sb, `Best Results in ${selectedYear}`, false, 'sb', stats.pb)}
                                        ${RecordTable(stats.pb, `All-Time Personal Records (PRs) Up To ${selectedYear}`, false, 'pb')}
                                    `}
                                    
                                </div>
                            ` : activeTab === 'solves' ? `
                                <div>
                                    <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                                        <i data-lucide="layers" class="text-indigo-400 w-6 h-6"></i> Total Solves
                                    </h3>
                                    ${SolveCountTable(stats.solveCounts, stats.totalSolves, stats.totalAttempts)}
                                    
                                    <h3 id="record-timeline" class="text-2xl font-bold text-white my-12 flex items-center gap-3">
                                        <i data-lucide="trending-up" class="text-emerald-400 w-7 h-7"></i>
                                        Record Timeline
                                    </h3>
                                    ${TimelineView(stats.timeline)}
                             
                                </div>
                            ` : ''}
                        </div>
                    `}
                </main>
            `;
            
            APP_ROOT.innerHTML = appHtml;
            updateIcons();
            
            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                searchForm.onsubmit = window.handleSearch;
            }
        };

        window.addEventListener('load', () => {
            renderApp(); 
            fetchData(window.state.wcaId);
        });
        
        document.addEventListener('input', e => {
            if (e.target.id === 'wcaSearchInput') {
                e.target.value = e.target.value.toUpperCase();
                window.state.inputWcaId = e.target.value;
            }
        });

    </script>
</body>
</html>
