<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuber WCA Career Summary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'slate': {
                            950: '#0c1015',
                            900: '#111827',
                            800: '#1f2937',
                            700: '#374151',
                            600: '#4b5563',
                            500: '#6b7280',
                        },
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Checkbox Styles */
        .checkbox-wrapper input:checked + div {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .checkbox-wrapper input:checked + div svg {
            display: block;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-900 text-slate-200">

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
        // Initialize Lucide icons
        const updateIcons = () => { if (typeof lucide !== 'undefined') lucide.createIcons(); };
        window.addEventListener('load', updateIcons);
    </script>
    
    <div id="app">
    </div>

    <script>
        // --- DATA & CONFIG ---
        const WCA_ID_DEFAULT = '2017KWAN05';
        const APP_ROOT = document.getElementById('app');
        
        // Define all events and their sorting order
        const EVENT_ORDER = [
            "333", "222", "444", "555", "666", "777", 
            "333bf", "333fm", "333oh", "clock", "minx", 
            "pyram", "skewb", "sq1", "444bf", "555bf", "333mbf",
            "333ft", "magic", "mmagic" // Non-official/old events
        ];

        // Custom event info (using a uniform color for tables)
        const EVENT_MAP = {
            "333": { name: "3x3x3", color: "text-yellow-400", bg: "bg-yellow-400" },
            "222": { name: "2x2x2", color: "text-gray-300", bg: "bg-gray-300" },
            "444": { name: "4x4x4", color: "text-green-400", bg: "bg-green-400" },
            "555": { name: "5x5x5", color: "text-red-400", bg: "bg-red-400" },
            "666": { name: "6x6x6", color: "text-red-600", bg: "bg-red-600" },
            "777": { name: "7x7x7", color: "text-blue-500", bg: "bg-blue-500" },
            "333oh": { name: "3x3 OH", color: "text-orange-400", bg: "bg-orange-400" },
            "333fm": { name: "3x3 FMC", color: "text-emerald-400", bg: "bg-emerald-400" },
            "333bf": { name: "3x3 BLD", color: "text-emerald-600", bg: "bg-emerald-600" },
            "333mbf": { name: "3x3 Multi-Blind", color: "text-slate-400", bg: "bg-slate-400" },
            "pyram": { name: "Pyraminx", color: "text-yellow-200", bg: "bg-yellow-200" },
            "minx": { name: "Megaminx", color: "text-pink-400", bg: "bg-pink-400" },
            "skewb": { name: "Skewb", color: "text-orange-300", bg: "bg-orange-300" },
            "sq1": { name: "Square-1", color: "text-blue-300", bg: "bg-blue-300" },
            "clock": { name: "Clock", color: "text-teal-300", bg: "bg-teal-300" },
            "444bf": { name: "4x4 BLD", color: "text-green-600", bg: "bg-green-600" },
            "555bf": { name: "5x5 BLD", color: "text-red-600", bg: "bg-red-600" },
            "333ft": { name: "3x3 Feet", color: "text-gray-600", bg: "bg-gray-600" },
            "magic": { name: "Magic", color: "text-indigo-400", bg: "bg-indigo-400" },
            "mmagic": { name: "Master Magic", color: "text-indigo-600", bg: "bg-indigo-600" },
        };
        
        const getEventInfo = (eventId) => EVENT_MAP[eventId] || { name: eventId, color: "text-gray-400", bg: "bg-gray-400" };
        
        const ROUND_ORDER = {
            "Qualification round": 0,
            "First round": 1,
            "Combined First round": 1,
            "Second round": 2,
            "Semi Final": 3,
            "Final": 4,
            "Combined Final": 4
        };
        const getRoundPriority = (roundName) => ROUND_ORDER[roundName] !== undefined ? ROUND_ORDER[roundName] : 99;      
        
        // --- STATE MANAGEMENT ---
        let wcaId = WCA_ID_DEFAULT;
        let inputWcaId = WCA_ID_DEFAULT;
        let userData = null;
        let historyData = [];
        let loading = false;
        let error = null;
        let selectedYear = 'All Time';
        let activeTab = 'overview';
        let viewMode = 'profile'; // 'profile' or 'leaderboard'
        let compMetadata = {};
        let loadingMetadata = false;
        let metadataFetchInProgress = false; 
        let selectedEvent = null; 
        
        // Leaderboard State
        let leaderboardData = [];
        let isGeneratingLeaderboard = false;
        let leaderboardProgress = 0;
        let leaderboardLimit = 20; 
        let leaderboardSort = 'prs'; 
        
        // Selection Modal State
        let showTop200Modal = false;
        let top200List = [];
        let selectedTop200Ids = new Set();
        let loadingTop200 = false;
        let cachedNames = {}; // Store fetched names: { wcaId: "Name" }

        window.state = { 
            wcaId, inputWcaId, userData, historyData, loading, error, 
            selectedYear, activeTab, viewMode, compMetadata, loadingMetadata, metadataFetchInProgress, selectedEvent,
            leaderboardData, isGeneratingLeaderboard, leaderboardProgress, leaderboardLimit, leaderboardSort,
            showTop200Modal, top200List, selectedTop200Ids, loadingTop200, cachedNames
        };

        let chartInstance = null; 
        let statsChartInstances = {};

        window.setState = (newState) => {
            Object.assign(window.state, newState);
            renderApp();
        };

        // --- UTILITY FUNCTIONS ---

        const formatResult = (centiseconds, eventId, type = 'single') => {
            if (centiseconds === -1) return "DNF";
            if (centiseconds === -2) return "DNS";
            if (centiseconds === 0 || centiseconds == null) return "-";

            if (eventId === '333mbf') {
                const R = centiseconds;
                const missed = R % 100; 
                const timeInSeconds = Math.floor(R / 100) % 100000; 
                const difference = Math.floor(R / 10000000); 
                const mins = Math.floor(timeInSeconds / 60);
                const secs = timeInSeconds % 60;
                const timeStr = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
                const solved = (99 - difference) + missed;
                const attempted = solved + missed;
                if (solved < 0 || attempted < 0) return R.toString(); 
                return `${solved}/${attempted} ${timeStr}`;
            }

            if (eventId === '333fm') {
                if (type === 'average' || centiseconds > 1000) {
                    return (centiseconds / 100).toFixed(2);
                }
                return centiseconds.toString();
            }

            let mins = Math.floor(centiseconds / 6000);
            let secs = Math.floor((centiseconds % 6000) / 100);
            let decis = centiseconds % 100;
            let sDecis = decis < 10 ? `0${decis}` : decis;
            let sSecs = secs < 10 && mins > 0 ? `0${secs}` : secs;

            if (mins > 0) return `${mins}:${sSecs}.${sDecis}`;
            return `${secs}.${sDecis}`;
        };

        const extractYearFromId = (compId) => {
            const match = compId.match(/(\d{4})$/);
            return match ? parseInt(match[0], 10) : new Date().getFullYear();
        };

        const processWcaData = (data) => {
            if (!data || !data.results) return [];
            const yearsMap = new Map();
            const sortedCompIds = Object.keys(data.results).sort((a, b) => a.localeCompare(b));

            sortedCompIds.forEach((compId) => {
                const eventsData = data.results[compId];
                const year = extractYearFromId(compId);
                if (!yearsMap.has(year)) {
                    yearsMap.set(year, { year, competitions: [] });
                }
                const yearEntry = yearsMap.get(year);
                const eventsList = Object.keys(eventsData).filter(e => e !== '333mbo'); 
                
                let roundsCount = 0;
                const results = [];
                let solvesCount = 0;
                let attemptsCount = 0;

                Object.entries(eventsData).forEach(([eventId, rounds]) => {
                    if (eventId === '333mbo') return; 
                    rounds.forEach(roundData => {
                        roundsCount++;
                        if (roundData.solves) {
                            roundData.solves.forEach(s => {
                                if (s > 0) attemptsCount++;
                                if (s === -1) attemptsCount++;
                                if (s > 0) solvesCount++;
                            });
                        }
                        results.push({
                            event: eventId,
                            round: roundData.round,
                            place: roundData.position,
                            best: roundData.best,
                            average: roundData.average,
                            format: roundData.format,
                            solves: roundData.solves
                        });
                    });
                });
                yearEntry.competitions.push({
                    id: compId, name: compId, events: eventsList,
                    rounds: roundsCount, solvesCount, attemptsCount, results: results
                });
            });
            return Array.from(yearsMap.values()).sort((a, b) => b.year - a.year);
        };
        
        // --- DATA FETCHING ---

        const fetchCompDetails = async (compIds) => {
            const { compMetadata, metadataFetchInProgress } = window.state;
            if (metadataFetchInProgress) return; 

            const missingIds = compIds.filter(id => compMetadata[id] === undefined);
            if (missingIds.length === 0) return;

            window.setState({ loadingMetadata: true, metadataFetchInProgress: true });
            
            const chunkSize = 5;
            for (let i = 0; i < missingIds.length; i += chunkSize) {
                const chunk = missingIds.slice(i, i + chunkSize);
                await Promise.all(chunk.map(async (id) => {
                    try {
                        let res;
                        for (let attempt = 0; attempt < 2; attempt++) {
                            res = await fetch(`https://raw.githubusercontent.com/robiningelbrecht/wca-rest-api/master/api/competitions/${id}.json`);
                            if (res.ok) break;
                            await new Promise(resolve => setTimeout(resolve, 500 * (attempt + 1))); 
                        }
                        if (res && res.ok) {
                            const data = await res.json();
                            compMetadata[id] = data;
                        } else {
                             compMetadata[id] = { name: id, country: 'Unknown', city: '', error: true };
                        }
                    } catch (e) {
                        compMetadata[id] = { name: id, country: 'Unknown', city: '', error: true };
                    }
                }));
                window.setState({ compMetadata: { ...compMetadata } });
            }
            window.setState({ loadingMetadata: false, metadataFetchInProgress: false });
        };

        const fetchData = async (id) => {
            window.setState({ loading: true, error: null, compMetadata: {} });
            try {
                const response = await fetch(`https://raw.githubusercontent.com/robiningelbrecht/wca-rest-api/master/api/persons/${id}.json`);
                if (!response.ok) throw new Error("Competitor not found");
                const data = await response.json();
                
                window.setState({
                    userData: {
                        name: data.name, wcaId: data.id, country: data.country,
                        avatar: `https://flagcdn.com/w160/${data.country.toLowerCase()}.png`
                    },
                    historyData: processWcaData(data),
                    selectedYear: 'All Time'
                });
            } catch (err) {
                window.setState({ error: err.message, userData: null, historyData: [] });
            } finally {
                window.setState({ loading: false });
            }
        };

        const fetchNamesBackground = async (items) => {
            const { cachedNames } = window.state;
            const missing = items.filter(i => !cachedNames[i.personId]);
            if (missing.length === 0) return;

            // Fetch in chunks to avoid rate limits
            const chunkSize = 5;
            for (let i = 0; i < missing.length; i += chunkSize) {
                if (!window.state.showTop200Modal) break; // Stop if modal closed
                const chunk = missing.slice(i, i + chunkSize);
                await Promise.all(chunk.map(async (item) => {
                    try {
                        const res = await fetch(`https://raw.githubusercontent.com/robiningelbrecht/wca-rest-api/master/api/persons/${item.personId}.json`);
                        if (res.ok) {
                            const data = await res.json();
                            cachedNames[item.personId] = data.name;
                        }
                    } catch (e) { console.error(e); }
                }));
                window.setState({ cachedNames: { ...cachedNames } });
                await new Promise(r => setTimeout(r, 100)); // Gentle delay
            }
        };

        const fetchTop200 = async () => {
            if (window.state.top200List.length > 0) {
                window.setState({ showTop200Modal: true });
                return;
            }
            window.setState({ showTop200Modal: true, loadingTop200: true });
            try {
                // Fetch top 200 HK average 3x3 as base population
                const res = await fetch(`https://raw.githubusercontent.com/robiningelbrecht/wca-rest-api/master/api/rank/HK/average/333.json`);
                if (!res.ok) throw new Error("Failed to fetch top list");
                const data = await res.json();
                const items = data.items.slice(0, 200);
                window.setState({ top200List: items, loadingTop200: false });
                
                // Trigger background fetch for names
                fetchNamesBackground(items);
            } catch (e) {
                alert("Error fetching top list: " + e.message);
                window.setState({ showTop200Modal: false, loadingTop200: false });
            }
        };
        
        // --- LEADERBOARD LOGIC ---
        
        const fetchLeaderboard = async (mode = 'preset') => {
            // mode: 'preset', 'custom', 'selection'
            const { leaderboardLimit, selectedYear, selectedTop200Ids } = window.state;
            let customIds = [];
            
            if (mode === 'custom') {
                const inputVal = document.getElementById('customLeaderboardIds').value;
                if (!inputVal || !inputVal.trim()) {
                    alert("Please enter at least one WCA ID.");
                    return;
                }
                customIds = inputVal.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            }

            window.setState({ isGeneratingLeaderboard: true, leaderboardProgress: 0, leaderboardData: [] });
            
            try {
                let targetIds = [];
                
                if (mode === 'custom') {
                    targetIds = customIds;
                } else if (mode === 'selection') {
                    targetIds = Array.from(selectedTop200Ids);
                    if (targetIds.length === 0) {
                        alert("Please select at least one cuber.");
                        window.setState({ isGeneratingLeaderboard: false });
                        return;
                    }
                } else {
                    // Preset: Top N HK
                    const rankRes = await fetch(`https://raw.githubusercontent.com/robiningelbrecht/wca-rest-api/master/api/rank/HK/average/333.json`);
                    if (!rankRes.ok) throw new Error("Failed to fetch rankings");
                    const rankData = await rankRes.json();
                    targetIds = rankData.items.slice(0, leaderboardLimit).map(i => i.personId);
                }
                
                const results = [];
                let processed = 0;
                
                for (const wcaId of targetIds) {
                    try {
                        const personRes = await fetch(`https://raw.githubusercontent.com/robiningelbrecht/wca-rest-api/master/api/persons/${wcaId}.json`);
                        if (personRes.ok) {
                            const personData = await personRes.json();
                            const history = processWcaData(personData);
                            
                            results.push({
                                id: personData.id,
                                name: personData.name,
                                avatar: `https://flagcdn.com/w40/${personData.country.toLowerCase()}.png`,
                                stats: calculateLeaderboardStats(history, personData.country, selectedYear)
                            });
                        }
                    } catch (e) {
                        console.error("Failed for", wcaId);
                    }
                    processed++;
                    window.setState({ leaderboardProgress: Math.round((processed / targetIds.length) * 100) });
                }
                
                window.setState({ leaderboardData: results, isGeneratingLeaderboard: false });
                
            } catch (e) {
                alert("Error generating leaderboard: " + e.message);
                window.setState({ isGeneratingLeaderboard: false });
            }
        };
        
        const calculateLeaderboardStats = (historyData, homeCountry, targetYearStr) => {
             const isAllTime = targetYearStr === 'All Time';
             const targetYear = isAllTime ? null : parseInt(targetYearStr);
             
             // Filter competitions
             const comps = isAllTime 
                ? historyData.flatMap(y => y.competitions) 
                : historyData.filter(y => y.year === targetYear).flatMap(y => y.competitions);
            
            let totalComps = comps.length;
            let totalSolves = 0;
            let medals = 0;
            
            // PR Calculation
            const currentBest = {};
            EVENT_ORDER.forEach(e => currentBest[e] = { single: Infinity, average: Infinity });
            
            // Sort all comps historically for PR calc
            // NOTE: Using ID sort as proxy for date when metadata isn't available
            const allHistoryComps = historyData.flatMap(y => y.competitions).sort((a,b) => {
                 const yA = extractYearFromId(a.id);
                 const yB = extractYearFromId(b.id);
                 return yA - yB || a.id.localeCompare(b.id);
            });
            
            let prCount = 0;
            
            allHistoryComps.forEach(comp => {
                const compYear = extractYearFromId(comp.id);
                const isInFilter = isAllTime || compYear === targetYear;
                
                // IMPORTANT: Sort results by Round Priority to ensure PRs are processed chronologically
                // e.g. First Round processed before Final.
                const sortedResults = [...comp.results].sort((a, b) => 
                    getRoundPriority(a.round) - getRoundPriority(b.round)
                );

                sortedResults.forEach(res => {
                    let isPR = false;
                    
                    // Inequality check (<=) ensures ties are counted as PRs (per user request)
                    if (res.best > 0 && res.best <= currentBest[res.event].single) {
                        currentBest[res.event].single = res.best;
                        if (isInFilter) isPR = true;
                    }
                    if (res.event !== '333mbf' && res.average > 0 && res.average <= currentBest[res.event].average) {
                        currentBest[res.event].average = res.average;
                        if (isInFilter) isPR = true;
                    }
                    
                    if (isInFilter && isPR) prCount++;
                    
                    if (isInFilter) {
                        // Medals (Finals only)
                        if (res.round.includes("Final") && res.place <= 3 && res.best > 0) {
                            medals++;
                        }
                    }
                });
            });
            
            comps.forEach(c => totalSolves += c.solvesCount);
            
            return {
                comps: totalComps,
                solves: totalSolves,
                prs: prCount,
                medals: medals,
                podiumsPerComp: totalComps > 0 ? medals / totalComps : 0,
                prsPerComp: totalComps > 0 ? prCount / totalComps : 0,
                solvesPerComp: totalComps > 0 ? totalSolves / totalComps : 0
            };
        };

        window.handleSearch = (e) => {
            e.preventDefault();
            const id = window.state.inputWcaId.trim().toUpperCase();
            if (id) {
                window.setState({ wcaId: id, selectedEvent: null });
                fetchData(id);
            }
        };

        // --- STATS CALCULATION ---
        
        const calculateTimelineAndCounts = (historyData, compMetadata, selectedYear = 'All Time') => {
          const isAllTime = selectedYear === 'All Time';
          const maxYear = isAllTime ? Infinity : parseInt(selectedYear);
          
          let allComps = historyData
              .filter(y => y.year <= maxYear)
              .flatMap(y => y.competitions);
      
          allComps.sort((a, b) => {
              const dateA = compMetadata[a.id]?.date?.from || '1900-01-01';
              const dateB = compMetadata[b.id]?.date?.from || '1900-01-01';
              return dateA.localeCompare(dateB) || a.id.localeCompare(b.id);
          });
      
          const timeline = {};
          const currentBest = {};
          const prCounts = {}; 
          const prEvents = new Set(); 
          
          EVENT_ORDER.forEach(e => {
              timeline[e] = [];
              currentBest[e] = { single: Infinity, average: Infinity };
          });
      
          allComps.forEach(comp => {
              const date = compMetadata[comp.id]?.date?.from || "";
              const compName = compMetadata[comp.id]?.name || comp.id;
              const year = extractYearFromId(comp.id);
      
              const sortedResults = [...comp.results].sort((a, b) =>
                  getRoundPriority(a.round) - getRoundPriority(b.round)
              );
              
              if (!prCounts[comp.id]) prCounts[comp.id] = 0;

              sortedResults.forEach(res => {
                  const eventId = res.event;
                  let improved = false;
                  const entries = [];
      
                  // Inequality check (<=) ensures ties are counted as PRs (per user request)
                  if (res.best > 0 && res.best <= currentBest[eventId].single) {
                      currentBest[eventId].single = res.best;
                      improved = true;
                      if (isAllTime || year === maxYear) {
                          entries.push({
                              type: 'Single',
                              formattedResult: formatResult(res.best, eventId, 'single'),
                              details: ''
                          });
                      }
                  }
      
                  if (eventId !== '333mbf' && res.average > 0 && res.average <= currentBest[eventId].average) {
                      currentBest[eventId].average = res.average;
                      improved = true;
                      if (isAllTime || year === maxYear) {
                          const details = res.solves ? '(' + res.solves
                              .filter(s => s !== 0)
                              .map(s => s === -1 ? 'DNF' : s === -2 ? 'DNS' : formatResult(s, eventId))
                              .join(', ') + ')' : '';
                          entries.push({
                              type: 'Average',
                              formattedResult: formatResult(res.average, eventId, 'average'),
                              details
                          });
                      }
                  }
      
                  if (entries.length > 0) {
                      prEvents.add(`${comp.id}:${eventId}`);
                      entries.forEach(entry => {
                          timeline[eventId].push({ ...entry, compName, date, round: res.round, compId: comp.id });
                          prCounts[comp.id] = (prCounts[comp.id] || 0) + 1; 
                      });
                  }
              });
          });
          Object.keys(timeline).forEach(k => timeline[k].length === 0 && delete timeline[k]);
          return { timeline, prCounts, prEvents };
        };

        const getAnnualStatistics = (historyData, prCounts) => {
            if (!historyData || historyData.length === 0) return [];

            const years = historyData.map(d => d.year);
            const minYear = Math.min(...years);
            const currentYear = new Date().getFullYear();
            const maxYear = Math.max(currentYear, ...years);

            const dataMap = new Map(historyData.map(d => [d.year, d]));

            const stats = [];
            
            for (let year = maxYear; year >= minYear; year--) {
                const yearData = dataMap.get(year);
                
                let yearComps = 0;
                let yearSolves = 0;
                let yearAttempts = 0;
                let yearPodiums = 0;
                let yearPRs = 0;

                if (yearData) {
                    yearData.competitions.forEach(comp => {
                        yearComps++;
                        yearSolves += comp.solvesCount;
                        yearAttempts += comp.attemptsCount;
                        yearPRs += (prCounts[comp.id] || 0);

                        comp.results.forEach(res => {
                            if (res.round.includes("Final") && res.place <= 3 && res.best > 0) {
                                yearPodiums++;
                            }
                        });
                    });
                }

                stats.push({
                    year: year,
                    comps: yearComps,
                    solves: yearSolves,
                    attempts: yearAttempts,
                    podiums: yearPodiums,
                    prs: yearPRs,
                    podiumsPerComp: yearComps > 0 ? (yearPodiums / yearComps) : 0,
                    prsPerComp: yearComps > 0 ? (yearPRs / yearComps) : 0,
                    solvesPerComp: yearComps > 0 ? (yearSolves / yearComps) : 0
                });
            }

            return stats;
        };

        const getStatsForYear = (yearStr, historyData, compMetadata, userData) => {
            const isAllTime = yearStr === 'All Time';
            const targetYear = isAllTime ? null : parseInt(yearStr);

            const comps = isAllTime 
                ? historyData.flatMap(y => y.competitions) 
                : historyData.filter(y => y.year === targetYear).flatMap(y => y.competitions);

            let totalComps = comps.length;
            let totalSolves = 0;
            let totalAttempts = 0;
            let uniqueCountries = new Set(), overseasCount = 0;
            let medals = { gold: 0, silver: 0, bronze: 0 };
            
            comps.forEach(comp => {
                totalSolves += comp.solvesCount;
                totalAttempts += comp.attemptsCount;
        
                const meta = compMetadata[comp.id];
                if (meta && !meta.error) {
                    uniqueCountries.add(meta.country);
                    if (userData?.country && meta.country !== userData.country) overseasCount++;
                }
        
                comp.results.forEach(res => {
                    if (res.round.includes("Final") && res.place <= 3 && res.best > 0) {
                        if (res.place === 1) medals.gold++; 
                        else if (res.place === 2) medals.silver++; 
                        else if (res.place === 3) medals.bronze++; 
                    }
                });
            });

            return {
                totalComps, totalSolves, totalAttempts,
                uniqueCountries: uniqueCountries.size, overseasCount,
                medals
            };
        };

        const calculateStats = (state) => {
            const { selectedYear, historyData, compMetadata, userData } = state;
            const isAllTime = selectedYear === 'All Time';
            
            const currentStats = getStatsForYear(selectedYear, historyData, compMetadata, userData);

            let prevStats = null;
            let prevTotalPRs = null;

            if (!isAllTime) {
                const prevYear = (parseInt(selectedYear) - 1).toString();
                prevStats = getStatsForYear(prevYear, historyData, compMetadata, userData);
                
                const { timeline: prevTimeline } = calculateTimelineAndCounts(historyData, compMetadata, prevYear);
                prevTotalPRs = 0;
                Object.values(prevTimeline).forEach(arr => prevTotalPRs += arr.length);
            }

            const statsComps = isAllTime 
                ? historyData.flatMap(y => y.competitions) 
                : historyData.filter(y => y.year === parseInt(selectedYear)).flatMap(y => y.competitions);
            
            let medalStats = {};
            let sb = { single: {}, average: {} };
            let pb = { single: {}, average: {} };

            const updateBest = (storage, event, result, compName) => {
                if (result > 0 && (!storage[event] || result < storage[event].value)) {
                    storage[event] = { value: result, comp: compName };
                }
            };
            
            // Historical PBs
            [...historyData].sort((a,b) => a.year - b.year).forEach(yData => {
                if (!isAllTime && yData.year > parseInt(selectedYear)) return;
                yData.competitions.forEach(c => {
                    c.results.forEach(r => {
                        updateBest(pb.single, r.event, r.best, c.name);
                        if (r.event !== '333mbf') updateBest(pb.average, r.event, r.average, c.name);
                    });
                });
            });

            statsComps.forEach(comp => {
                comp.results.forEach(res => {
                    if (res.round.includes("Final") && res.place <= 3 && res.best > 0) {
                        if (!medalStats[res.event]) medalStats[res.event] = { gold: 0, silver: 0, bronze: 0, total: 0 };
                        if (res.place === 1) medalStats[res.event].gold++;
                        else if (res.place === 2) medalStats[res.event].silver++;
                        else if (res.place === 3) medalStats[res.event].bronze++;
                        medalStats[res.event].total++;
                    }
                    updateBest(sb.single, res.event, res.best, comp.name);
                    if (res.event !== '333mbf') updateBest(sb.average, res.event, res.average, comp.name);
                });
            });

            const yearSolveCounts = {};
            const yearAttemptCounts = {};
            EVENT_ORDER.forEach(e => { yearSolveCounts[e] = 0; yearAttemptCounts[e] = 0; });
            statsComps.forEach(comp => {
                comp.results.forEach(res => {
                    if (res.solves) {
                        res.solves.forEach(s => {
                            if (s > 0) yearSolveCounts[res.event]++;
                            if (s !== 0) yearAttemptCounts[res.event]++;
                        });
                    }
                });
            });

            const { timeline, prCounts, prEvents } = calculateTimelineAndCounts(historyData, compMetadata, isAllTime ? 'All Time' : selectedYear);
            
            const prsByComp = {};
            Object.keys(timeline).forEach(evt => {
                timeline[evt].forEach(entry => {
                    if (!prsByComp[entry.compId]) prsByComp[entry.compId] = [];
                    prsByComp[entry.compId].push({ ...entry, eventId: evt });
                });
            });

            let totalPRs = 0;
            Object.values(timeline).forEach(arr => totalPRs += arr.length);

            const annualStats = isAllTime ? getAnnualStatistics(historyData, prCounts) : [];

            return {
                ...currentStats, 
                prevStats,
                medalStats, sb, pb, timeline,
                solveCounts: yearSolveCounts,
                attemptCounts: yearAttemptCounts,
                statsComps,
                prCounts, 
                prsByComp, 
                prEvents, 
                totalPRs, 
                prevTotalPRs, 
                annualStats 
            };
        };

        const renderSolvesChart = (comps, eventId) => {
            const ctx = document.getElementById('solvesChart');
            if (!ctx) return;
            if (chartInstance) chartInstance.destroy();

            const sortedComps = [...comps].sort((a, b) => {
                const dateA = window.state.compMetadata[a.id]?.date?.from || a.id;
                const dateB = window.state.compMetadata[b.id]?.date?.from || b.id;
                return dateA.localeCompare(dateB); 
            });

            const dataPoints = [];
            sortedComps.forEach(comp => {
                const eventResults = comp.results.filter(r => r.event === eventId);
                eventResults.sort((a,b) => getRoundPriority(a.round) - getRoundPriority(b.round));
                
                eventResults.forEach(res => {
                    if(res.solves) {
                        res.solves.forEach(solve => {
                            if (solve > 0) {
                                let val = solve;
                                if (eventId !== '333fm' && eventId !== '333mbf') val = solve / 100;
                                dataPoints.push({
                                    y: val,
                                    comp: comp.id,
                                    round: res.round
                                });
                            }
                        });
                    }
                });
            });

            if (dataPoints.length === 0) return;
            
            const n = dataPoints.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            dataPoints.forEach((p, i) => {
                sumX += i;
                sumY += p.y;
                sumXY += i * p.y;
                sumXX += i * i;
            });
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            const trendData = dataPoints.map((_, i) => slope * i + intercept);
            
            const runningMeanData = [];
            let sumSoFar = 0;
            
            dataPoints.forEach((point, i) => {
                sumSoFar += point.y;
                runningMeanData.push(sumSoFar / (i + 1)); 
            });
            
            const movingAvgData = dataPoints.map((_, i, arr) => {
                if (i < 4) return null; 
                const subset = arr.slice(i - 4, i + 1);
                const sum = subset.reduce((acc, curr) => acc + curr.y, 0);
                return sum / 5;
            });

            const sortedValues = dataPoints.map(p => p.y).sort((a, b) => a - b);
            const p95Index = Math.floor(sortedValues.length * 0.95);
            const p95Value = sortedValues[p95Index];
            const suggestedMax = p95Value * 1.1;

            const labels = dataPoints.map((_, i) => i + 1);

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Single Solves',
                            data: dataPoints.map(p => p.y),
                            borderColor: '#818cf8', 
                            backgroundColor: '#818cf8',
                            pointRadius: 2,
                            pointHoverRadius: 4,
                            borderWidth: 1,
                            tension: 0.1,
                            order: 4
                        },
                        {
                            label: '5-Solve Running Mean Trend',
                            data: movingAvgData,
                            borderColor: '#facc15', // yellow-400
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false,
                            tension: 0.3,
                            order: 2
                        },
                        {
                            label: 'Linear Trend',
                            data: trendData,
                            borderColor: '#34d399', // emerald-400
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false,
                            borderDash: [5, 5],
                            order: 3
                        },
                        {
                            label: 'Mean',
                            data: runningMeanData,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false,
                            tension: 0.3,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2);
                                        if (eventId !== '333fm' && eventId !== '333mbf') label += 's';
                                    }
                                    return label;
                                },
                                afterBody: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    const point = dataPoints[index];
                                    if (point) return `Comp: ${point.comp}\nRound: ${point.round}`;
                                }
                            }
                        },
                        legend: { labels: { color: '#94a3b8' } }
                    },
                    scales: {
                        y: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' },
                            title: { display: true, text: eventId === '333fm' ? 'Moves' : 'Seconds', color: '#64748b' },
                            suggestedMax: suggestedMax
                        },
                        x: { display: false }
                    }
                }
            });
        };

        const renderStatsCharts = (annualStats) => {
            const destroyChart = (id) => {
                if (statsChartInstances[id]) {
                    statsChartInstances[id].destroy();
                    delete statsChartInstances[id];
                }
            };

            const labels = annualStats.map(s => s.year);
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#94a3b8' } },
                },
                scales: {
                    y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', beginAtZero: true } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                }
            };

            const ctx1 = document.getElementById('chartSolvesAttempts');
            if (ctx1) {
                destroyChart('solvesAttempts');
                statsChartInstances['solvesAttempts'] = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            { label: 'Attempts', data: annualStats.map(s => s.attempts), backgroundColor: '#475569' },
                            { label: 'Solves', data: annualStats.map(s => s.solves), backgroundColor: '#818cf8' }
                        ]
                    },
                    options: commonOptions
                });
            }

            const ctx2 = document.getElementById('chartComps');
            if (ctx2) {
                destroyChart('comps');
                statsChartInstances['comps'] = new Chart(ctx2, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Competitions', data: annualStats.map(s => s.comps), backgroundColor: '#34d399' }] },
                    options: commonOptions
                });
            }

            const ctx3 = document.getElementById('chartPodiums');
            if (ctx3) {
                destroyChart('podiums');
                statsChartInstances['podiums'] = new Chart(ctx3, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Podiums', data: annualStats.map(s => s.podiums), backgroundColor: '#facc15' }] },
                    options: commonOptions
                });
            }

            const ctx4 = document.getElementById('chartPRs');
            if (ctx4) {
                destroyChart('prs');
                statsChartInstances['prs'] = new Chart(ctx4, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'PRs', data: annualStats.map(s => s.prs), backgroundColor: '#c084fc' }] },
                    options: commonOptions
                });
            }

            const ctx5 = document.getElementById('chartPodiumsRate');
            if (ctx5) {
                destroyChart('podiumsRate');
                statsChartInstances['podiumsRate'] = new Chart(ctx5, {
                    type: 'line',
                    data: { labels, datasets: [{ label: 'Podiums / Comp', data: annualStats.map(s => s.podiumsPerComp), borderColor: '#facc15', backgroundColor: '#facc15', tension: 0.3 }] },
                    options: commonOptions
                });
            }

            const ctx6 = document.getElementById('chartPRsRate');
            if (ctx6) {
                destroyChart('prsRate');
                statsChartInstances['prsRate'] = new Chart(ctx6, {
                    type: 'line',
                    data: { labels, datasets: [{ label: 'PRs / Comp', data: annualStats.map(s => s.prsPerComp), borderColor: '#c084fc', backgroundColor: '#c084fc', tension: 0.3 }] },
                    options: commonOptions
                });
            }

            const ctx7 = document.getElementById('chartSolvesRate');
            if (ctx7) {
                destroyChart('solvesRate');
                statsChartInstances['solvesRate'] = new Chart(ctx7, {
                    type: 'line',
                    data: { labels, datasets: [{ label: 'Solves / Comp', data: annualStats.map(s => s.solvesPerComp), borderColor: '#818cf8', backgroundColor: '#818cf8', tension: 0.3 }] },
                    options: commonOptions
                });
            }
        };

        // --- RENDERING COMPONENTS ---

        const TrendIndicator = (current, previous) => {
            if (previous === undefined || previous === null) {
                 return `<span class="text-slate-500 ml-2 text-xs"></span>`;
            }
            if (previous === 0 && current > 0) return `<span class="text-green-400 ml-2 text-xs font-medium flex items-center"><i data-lucide="chevrons-up" class="w-3 h-3 mr-0.5"></i>${current}<span class="opacity-70 ml-0.5">(New)</span></span>`;
            if (previous === 0 && current === 0) return `<span class="text-slate-500 ml-2 text-xs"><i data-lucide="minus" class="inline w-3 h-3"></i></span>`;
            if (current === 0) return `<span class="text-red-400 ml-2 text-xs font-medium flex items-center"><i data-lucide="arrow-down-right" class="w-3 h-3 mr-0.5"></i>${previous}<span class="opacity-70 ml-0.5">(-100%)</span></span>`;
            
            const diff = current - previous;
            if (diff === 0) return `<span class="text-slate-500 ml-2 text-xs"><i data-lucide="minus" class="inline w-3 h-3"></i></span>`;

            const percentage = ((diff / previous) * 100).toFixed(0);
            const isPositive = diff > 0;
            return `<span class="ml-2 text-xs font-medium flex items-center ${isPositive ? "text-green-400" : "text-red-400"}"><i data-lucide="${isPositive ? "arrow-up-right" : "arrow-down-right"}" class="w-3 h-3 mr-0.5"></i>${Math.abs(diff)}<span class="opacity-70 ml-0.5">(${percentage}%)</span></span>`;
        };

        const StatCard = ({ title, value, subtext, icon, colorClass, trendHtml }) => `
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg flex items-center space-x-4 relative overflow-hidden">
                <div class="p-4 rounded-full bg-slate-700/50 ${colorClass} z-10"><i data-lucide="${icon}" class="w-7 h-7"></i></div>
                <div class="z-10 flex-1">
                    <h3 class="text-slate-400 text-sm font-medium uppercase tracking-wider">${title}</h3>
                    <div class="flex items-baseline"><div class="text-3xl font-bold text-white mt-1">${value}</div>${trendHtml || ''}</div>
                    ${subtext ? `<div class="text-slate-500 text-xs mt-1">${subtext}</div>` : ''}
                </div>
            </div>`;

        const StatsSection = (annualStats) => {
            if (!annualStats || annualStats.length === 0) return '';
            
            const createTableRows = (mapper) => {
                let total = 0;
                let rows = annualStats.map(s => {
                   const val = mapper(s);
                   if (typeof val === 'number' && !Number.isInteger(val)) return val; 
                   total += val;
                   return val;
                }).map((val, i) => `
                   <tr class="border-b border-slate-800 last:border-0 hover:bg-slate-800/50">
                       <td class="px-4 py-2 font-mono text-slate-400">${annualStats[i].year}</td>
                       <td class="px-4 py-2 text-white font-bold text-right">${typeof val === 'number' && !Number.isInteger(val) ? val.toFixed(2) : val}</td>
                   </tr>
                `).join('');
                
                return rows;
            };

            const createContainer = (title, chartId, tableRows, footerValue) => `
                <div class="bg-slate-950 rounded-xl border border-slate-800 overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-slate-800 font-bold text-white text-lg flex items-center gap-2">
                        ${title}
                    </div>
                    <div class="h-64 p-4 relative">
                        <canvas id="${chartId}"></canvas>
                    </div>
                    <div class="bg-slate-900 border-t border-slate-800">
                        <div class="max-h-48 overflow-y-auto no-scrollbar">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-950 text-slate-500 text-xs uppercase sticky top-0">
                                    <tr><th class="px-4 py-2">Year</th><th class="px-4 py-2 text-right">Value</th></tr>
                                </thead>
                                <tbody>${tableRows}</tbody>
                                <tfoot class="bg-slate-950 border-t border-slate-800 font-bold text-indigo-400">
                                    <tr><td class="px-4 py-2">All Time</td><td class="px-4 py-2 text-right">${footerValue}</td></tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            const totalSolves = annualStats.reduce((acc, c) => acc + c.solves, 0);
            const totalAttempts = annualStats.reduce((acc, c) => acc + c.attempts, 0);
            const totalComps = annualStats.reduce((acc, c) => acc + c.comps, 0);
            const totalPodiums = annualStats.reduce((acc, c) => acc + c.podiums, 0);
            const totalPRs = annualStats.reduce((acc, c) => acc + c.prs, 0);
            
            const ratePodiums = totalComps > 0 ? (totalPodiums / totalComps).toFixed(2) : "0.00";
            const ratePRs = totalComps > 0 ? (totalPRs / totalComps).toFixed(2) : "0.00";
            const rateSolves = totalComps > 0 ? (totalSolves / totalComps).toFixed(2) : "0.00";

            return `
                <div class="mt-12 pt-10 border-t border-slate-800">
                    <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-2"><i data-lucide="bar-chart-2" class="text-indigo-400 w-6 h-6"></i> Annual Statistics</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        ${createContainer("Solves vs Attempts", "chartSolvesAttempts", 
                            annualStats.map(s => `<tr class="border-b border-slate-800 last:border-0 hover:bg-slate-800/50"><td class="px-4 py-2 font-mono text-slate-400">${s.year}</td><td class="px-4 py-2 text-white font-bold text-right">${s.solves} / ${s.attempts}</td></tr>`).join(''), 
                            `${totalSolves} / ${totalAttempts}`)}
                        
                        ${createContainer("Competitions", "chartComps", createTableRows(s => s.comps), totalComps)}
                        ${createContainer("Podiums", "chartPodiums", createTableRows(s => s.podiums), totalPodiums)}
                        ${createContainer("PRs", "chartPRs", createTableRows(s => s.prs), totalPRs)}
                        
                        ${createContainer("Podiums per Comp", "chartPodiumsRate", createTableRows(s => s.podiumsPerComp), ratePodiums)}
                        ${createContainer("PRs per Comp", "chartPRsRate", createTableRows(s => s.prsPerComp), ratePRs)}
                        ${createContainer("Solves per Comp", "chartSolvesRate", createTableRows(s => s.solvesPerComp), rateSolves)}
                    </div>
                </div>
            `;
        };
        
        // --- LEADERBOARD VIEW ---
        const LeaderboardView = () => {
             const { leaderboardData, isGeneratingLeaderboard, leaderboardProgress, leaderboardSort, selectedYear } = window.state;
             
             let sortedData = [...leaderboardData];
             if (leaderboardSort) {
                 sortedData.sort((a, b) => b.stats[leaderboardSort] - a.stats[leaderboardSort]);
             }
             
             const currentYear = new Date().getFullYear();
             const years = [];
             for(let y = currentYear; y >= 2000; y--) years.push(y);
             
             const renderRow = (item, index) => `
                <tr class="border-b border-slate-800 hover:bg-slate-800/50 transition-colors">
                    <td class="px-4 py-3 font-mono text-slate-500 w-12 text-center">#${index + 1}</td>
                    <td class="px-4 py-3 group cursor-pointer" onclick="window.openProfile('${item.id}')">
                        <div class="flex items-center gap-3">
                            <img src="${item.avatar}" class="w-8 h-8 rounded-full bg-slate-800 object-cover border border-slate-700 group-hover:border-indigo-500 transition-colors" onerror="this.style.display='none'">
                            <div>
                                <div class="text-white font-bold text-sm group-hover:text-indigo-400 transition-colors flex items-center gap-1">
                                    ${item.name} <i data-lucide="arrow-up-right" class="w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                </div>
                                <div class="text-xs text-slate-500">${item.id}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-right font-mono font-bold ${leaderboardSort === 'comps' ? 'text-indigo-400' : 'text-slate-300'}">${item.stats.comps}</td>
                    <td class="px-4 py-3 text-right font-mono font-bold ${leaderboardSort === 'solves' ? 'text-indigo-400' : 'text-slate-300'}">${item.stats.solves}</td>
                    <td class="px-4 py-3 text-right font-mono font-bold ${leaderboardSort === 'prs' ? 'text-indigo-400' : 'text-slate-300'}">${item.stats.prs}</td>
                    <td class="px-4 py-3 text-right font-mono font-bold ${leaderboardSort === 'medals' ? 'text-indigo-400' : 'text-slate-300'}">${item.stats.medals}</td>
                    <td class="px-4 py-3 text-right font-mono text-sm ${leaderboardSort === 'podiumsPerComp' ? 'text-indigo-400 font-bold' : 'text-slate-400'}">${item.stats.podiumsPerComp.toFixed(2)}</td>
                    <td class="px-4 py-3 text-right font-mono text-sm ${leaderboardSort === 'prsPerComp' ? 'text-indigo-400 font-bold' : 'text-slate-400'}">${item.stats.prsPerComp.toFixed(2)}</td>
                    <td class="px-4 py-3 text-right font-mono text-sm ${leaderboardSort === 'solvesPerComp' ? 'text-indigo-400 font-bold' : 'text-slate-400'}">${item.stats.solvesPerComp.toFixed(2)}</td>
                </tr>
             `;
             
             return `
                <div class="space-y-6 animate-fade-in-up">
                    <div class="bg-slate-800/50 p-6 rounded-xl border border-slate-700/50">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="trophy" class="text-indigo-400 w-6 h-6"></i>
                            <h3 class="text-xl font-bold text-white">Leaderboard Generator</h3>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Preset Column -->
                            <div class="space-y-3">
                                <label class="text-sm font-medium text-slate-400">Preset: Top HK 3x3 Average</label>
                                <div class="flex flex-wrap gap-2">
                                    <select id="leaderboardLimitSelect" onchange="window.setState({ leaderboardLimit: parseInt(this.value) })" class="bg-slate-900 border border-slate-700 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5">
                                        <option value="10" ${window.state.leaderboardLimit === 10 ? 'selected' : ''}>Top 10</option>
                                        <option value="20" ${window.state.leaderboardLimit === 20 ? 'selected' : ''}>Top 20</option>
                                        <option value="50" ${window.state.leaderboardLimit === 50 ? 'selected' : ''}>Top 50</option>
                                    </select>
                                    <button onclick="fetchLeaderboard('preset')" ${isGeneratingLeaderboard ? 'disabled' : ''} class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 text-white text-sm font-bold rounded-lg transition-colors whitespace-nowrap">
                                        Load Preset
                                    </button>
                                    <button onclick="fetchTop200()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 border border-slate-600 text-white text-sm font-medium rounded-lg transition-colors whitespace-nowrap flex items-center gap-2">
                                        <i data-lucide="list-plus" class="w-4 h-4"></i> Select from Top 200
                                    </button>
                                </div>
                            </div>

                            <!-- Custom Column -->
                            <div class="space-y-3">
                                <label class="text-sm font-medium text-slate-400">Custom: Compare Specific WCA IDs</label>
                                <div class="flex gap-2">
                                    <input type="text" id="customLeaderboardIds" placeholder="2017KWAN05, 2015LEON02..." class="bg-slate-900 border border-slate-700 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                                    <button onclick="fetchLeaderboard('custom')" ${isGeneratingLeaderboard ? 'disabled' : ''} class="px-4 py-2 bg-slate-700 hover:bg-slate-600 disabled:opacity-50 text-white text-sm font-bold rounded-lg transition-colors whitespace-nowrap">
                                        Compare IDs
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Global Settings (Year) -->
                         <div class="mt-6 pt-4 border-t border-slate-700/50 flex items-center gap-4">
                            <label class="text-sm font-medium text-slate-400">Statistics Year:</label>
                            <select onchange="window.setState({ selectedYear: this.value })" class="bg-slate-900 border border-slate-700 text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 w-32">
                                <option value="All Time" ${selectedYear === 'All Time' ? 'selected' : ''}>All Time</option>
                                ${years.map(y => `<option value="${y}" ${selectedYear == y ? 'selected' : ''}>${y}</option>`).join('')}
                            </select>
                            ${isGeneratingLeaderboard ? `<span class="ml-auto text-indigo-400 text-sm font-mono flex items-center gap-2"><i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> Processing... ${leaderboardProgress}%</span>` : ''}
                        </div>
                    </div>

                    ${leaderboardData.length > 0 ? `
                        <div class="overflow-x-auto rounded-xl border border-slate-800 shadow-xl">
                            <table class="w-full text-left bg-slate-900">
                                <thead class="bg-slate-950 text-slate-400 text-xs uppercase font-semibold">
                                    <tr>
                                        <th class="px-4 py-3 text-center">#</th>
                                        <th class="px-4 py-3">Cuber</th>
                                        <th class="px-4 py-3 text-right cursor-pointer hover:text-white" onclick="window.setState({ leaderboardSort: 'comps' })">Comps ${leaderboardSort === 'comps' ? '' : ''}</th>
                                        <th class="px-4 py-3 text-right cursor-pointer hover:text-white" onclick="window.setState({ leaderboardSort: 'solves' })">Solves ${leaderboardSort === 'solves' ? '' : ''}</th>
                                        <th class="px-4 py-3 text-right cursor-pointer hover:text-white" onclick="window.setState({ leaderboardSort: 'prs' })">PRs ${leaderboardSort === 'prs' ? '' : ''}</th>
                                        <th class="px-4 py-3 text-right cursor-pointer hover:text-white" onclick="window.setState({ leaderboardSort: 'medals' })">Medals ${leaderboardSort === 'medals' ? '' : ''}</th>
                                        <th class="px-4 py-3 text-right cursor-pointer hover:text-white" onclick="window.setState({ leaderboardSort: 'podiumsPerComp' })">Podium Rate ${leaderboardSort === 'podiumsPerComp' ? '' : ''}</th>
                                        <th class="px-4 py-3 text-right cursor-pointer hover:text-white" onclick="window.setState({ leaderboardSort: 'prsPerComp' })">PR Rate ${leaderboardSort === 'prsPerComp' ? '' : ''}</th>
                                        <th class="px-4 py-3 text-right cursor-pointer hover:text-white" onclick="window.setState({ leaderboardSort: 'solvesPerComp' })">Solves/Comp ${leaderboardSort === 'solvesPerComp' ? '' : ''}</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-800 text-sm">
                                    ${sortedData.map(renderRow).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : isGeneratingLeaderboard ? `
                         <div class="py-20 flex flex-col items-center justify-center text-slate-500">
                            <div class="w-64 h-2 bg-slate-800 rounded-full overflow-hidden mb-4">
                                <div class="h-full bg-indigo-500 transition-all duration-300 ease-out" style="width: ${leaderboardProgress}%"></div>
                            </div>
                            <p class="text-sm">Fetching career data... (${leaderboardProgress}%)</p>
                        </div>
                    ` : `
                        <div class="py-20 text-center text-slate-500 border border-slate-800 rounded-xl border-dashed">
                            <i data-lucide="bar-chart-big" class="mx-auto mb-3 opacity-20 w-12 h-12"></i>
                            <p>Click "Load Preset" or "Compare IDs" to generate data.</p>
                        </div>
                    `}
                </div>
             `;
        };
        
        // --- SELECTION MODAL ---
        const Top200Modal = () => {
            if (!window.state.showTop200Modal) return '';
            
            const { top200List, selectedTop200Ids, loadingTop200 } = window.state;
            
            const toggleSelection = (id) => {
                const newSet = new Set(selectedTop200Ids);
                if (newSet.has(id)) newSet.delete(id);
                else {
                    if (newSet.size >= 20) {
                        alert("Please select max 20 cubers to avoid API rate limits.");
                        return;
                    }
                    newSet.add(id);
                }
                window.setState({ selectedTop200Ids: newSet });
            };
            
            return `
                <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm">
                    <div class="bg-slate-900 w-full max-w-2xl rounded-xl border border-slate-700 shadow-2xl flex flex-col max-h-[80vh]">
                        <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                            <h3 class="text-lg font-bold text-white">Select from Top 200 (HK 3x3 Average)</h3>
                            <button onclick="window.setState({ showTop200Modal: false })" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div class="p-4 flex-1 overflow-y-auto no-scrollbar">
                            ${loadingTop200 ? `
                                <div class="flex flex-col items-center justify-center py-12 text-slate-500">
                                    <i data-lucide="loader-2" class="animate-spin w-8 h-8 mb-2"></i>
                                    Loading List...
                                </div>
                            ` : `
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                    ${top200List.map(p => {
                                        const name = window.state.cachedNames[p.personId] || p.personName || p.name || p.personId;
                                        return `
                                        <div class="flex items-center p-2 rounded hover:bg-slate-800 cursor-pointer border border-transparent hover:border-slate-700" onclick="const cb = this.querySelector('input'); cb.click();">
                                            <div class="checkbox-wrapper relative flex items-center mr-3">
                                                <input type="checkbox" 
                                                    class="peer appearance-none w-5 h-5 border border-slate-600 rounded bg-slate-800 checked:bg-indigo-600 checked:border-indigo-600 transition-colors cursor-pointer"
                                                    ${selectedTop200Ids.has(p.personId) ? 'checked' : ''}
                                                    onclick="event.stopPropagation(); window.toggleTop200Selection('${p.personId}')"
                                                >
                                                <i data-lucide="check" class="absolute w-3.5 h-3.5 text-white left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none opacity-0 peer-checked:opacity-100"></i>
                                            </div>
                                            <div>
                                                <div class="text-sm font-medium text-white">${name}</div>
                                                <div class="text-xs text-slate-500 font-mono flex gap-2">
                                                    <span>${p.personId}</span>
                                                    <span class="text-indigo-400 font-bold">${(p.best/100).toFixed(2)}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `; }).join('')}
                                </div>
                            `}
                        </div>
                        <div class="p-4 border-t border-slate-800 flex justify-between items-center bg-slate-900 rounded-b-xl">
                            <span class="text-sm text-slate-400">${selectedTop200Ids.size} selected (Max 20)</span>
                            <div class="flex gap-2">
                                <button onclick="window.setState({ showTop200Modal: false })" class="px-4 py-2 rounded-lg text-sm font-medium text-slate-400 hover:text-white">Cancel</button>
                                <button onclick="window.setState({ showTop200Modal: false }); fetchLeaderboard('selection');" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold rounded-lg transition-colors shadow-lg shadow-indigo-500/20">
                                    Generate Leaderboard
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };
        
        // Expose toggle function globally
        window.toggleTop200Selection = (id) => {
            const { selectedTop200Ids } = window.state;
             const newSet = new Set(selectedTop200Ids);
            if (newSet.has(id)) newSet.delete(id);
            else {
                if (newSet.size >= 20) {
                    alert("Please select max 20 cubers to avoid API rate limits.");
                    return;
                }
                newSet.add(id);
            }
            window.setState({ selectedTop200Ids: newSet });
        };

        // --- COMPETITION ITEM ---
        const CompetitionItem = (comp, prCount, compPRs) => {
            const metadata = window.state.compMetadata[comp.id] || null;
            const compName = metadata?.name || comp.id;
            const link = `https://www.worldcubeassociation.org/competitions/${comp.id}`;
            
            const eventsMap = new Map();
            comp.results.forEach(res => {
                if (!eventsMap.has(res.event)) {
                    eventsMap.set(res.event, []);
                }
                eventsMap.get(res.event).push(res);
            });

            const eventResultsHtml = Array.from(eventsMap.entries())
                .filter(([event, rounds]) => {
                    return rounds.some(r => r.round.includes("Final") && r.place <= 3 && r.best > 0);
                })
                .sort(([a], [b]) => EVENT_ORDER.indexOf(a) - EVENT_ORDER.indexOf(b))
                .map(([event, rounds]) => {
                    const eventInfo = getEventInfo(event);
                    rounds.sort((a, b) => getRoundPriority(a.round) - getRoundPriority(b.round));
                    
                    const roundHtml = rounds.map(res => {
                        let placeClass = 'text-slate-400 border-slate-700/50';
                        let iconHtml = '';
                        
                        const isFinalRound = res.round.includes("Final"); 
                        
                        if (res.place === 1 && res.best > 0 && isFinalRound) {
                            placeClass = 'text-yellow-400 bg-yellow-900/20 border-yellow-500/30 font-bold';
                            iconHtml = '<i data-lucide="award" class="w-3 h-3 text-yellow-400 mr-1 shrink-0"></i>';
                        } else if (res.place === 2 && res.best > 0 && isFinalRound) {
                            placeClass = 'text-gray-400 bg-gray-700/20 border-gray-400/30 font-bold';
                            iconHtml = '<i data-lucide="award" class="w-3 h-3 text-gray-400 mr-1 shrink-0"></i>';
                        } else if (res.place === 3 && res.best > 0 && isFinalRound) {
                            placeClass = 'text-amber-700 bg-amber-900/20 border-amber-700/30 font-bold';
                            iconHtml = '<i data-lucide="award" class="w-3 h-3 text-amber-700 mr-1 shrink-0"></i>';
                        }

                        return `
                            <div class="flex justify-between items-center text-xs py-1 px-2 rounded border ${placeClass}">
                                <span class="font-medium flex items-center">${iconHtml}${res.round.replace("round", "Rd").replace("Combined ", "")}</span>
                                <span class="font-mono text-white flex items-center gap-1">
                                    <span class="text-xs ${res.place > 0 ? 'font-bold' : 'text-slate-500'}">${res.place > 0 ? '#' + res.place : '-'}</span>
                                    ${formatResult(res.average > 0 ? res.average : res.best, res.event, res.average > 0 ? 'average' : 'single')}
                                </span>
                            </div>`;
                    }).join('');

                    return `
                        <div class="p-3 bg-slate-800 rounded-lg border border-slate-700 shadow-inner">
                            <h5 class="text-sm font-semibold text-white mb-2 flex items-center gap-2"><div class="w-2 h-2 rounded-full ${eventInfo.bg}"></div>${eventInfo.name}</h5>
                            <div class="space-y-1">${roundHtml}</div>
                        </div>`;
                }).join('');
            
            let prsHtml = '';
            if (compPRs && compPRs.length > 0) {
                 compPRs.sort((a, b) => EVENT_ORDER.indexOf(a.eventId) - EVENT_ORDER.indexOf(b.eventId));
                 
                 const prList = compPRs.map(pr => {
                     const eInfo = getEventInfo(pr.eventId);
                     return `<span class="inline-flex items-center justify-between px-2.5 py-1.5 bg-slate-800 rounded border border-slate-700 text-xs text-slate-300 shadow-sm w-[200px]">
                        <div class="flex items-center gap-1.5">
                            <div class="w-1.5 h-1.5 rounded-full ${eInfo.bg}"></div>
                            <span class="font-bold text-white truncate max-w-[500px]">${eInfo.name}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-mono text-indigo-300 font-bold">${pr.formattedResult}</span>
                            <span class="text-slate-500 text-[10px] uppercase tracking-wide opacity-75">${pr.type.substring(0,7)}</span>
                        </div>
                     </span>`;
                 }).join('');
                 
                 prsHtml = `<div class="mt-5 pt-4 border-t border-slate-1500/50 flex flex-wrap gap-2 items-center">
                    <span class="text-xs font-bold text-emerald-400 uppercase tracking-wider mr-2 flex items-center gap-1"><i data-lucide="trending-up" class="w-3 h-3"></i> PR:</span>
                    ${prList}
                 </div>`;
            }

            return `
                <div class="group relative border-l-2 border-slate-700 pl-6 pb-8 last:pb-0 hover:border-indigo-500 transition-colors">
                    <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-800 border-2 border-slate-600 group-hover:border-indigo-500 group-hover:scale-110 transition-all"></div>
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-2">
                        <div>
                            <div class="flex items-center gap-2"><h4 class="text-lg font-bold text-white group-hover:text-indigo-400 transition-colors"><a href="${link}" target="_blank" rel="noreferrer" class="flex items-center gap-2 hover:underline">${compName}<i data-lucide="external-link" class="w-3.5 h-3.5 opacity-50"></i></a></h4></div>
                            <div class="text-sm text-slate-400 flex flex-wrap items-center gap-3 mt-1">${metadata?.date ? `<span class="flex items-center gap-1"><i data-lucide="calendar" class="w-3.5 h-3.5"></i> ${metadata.date.from}</span>` : `<span class="flex items-center gap-1"><i data-lucide="hash" class="w-3.5 h-3.5"></i> ${comp.id}</span>`}${metadata?.city ? `<span class="flex items-center gap-1"><i data-lucide="map-pin" class="w-3.5 h-3.5"></i> ${metadata.city}, ${metadata.country}</span>` : ''}</div>
                        </div>
                        <div class="mt-2 sm:mt-0 flex gap-2 items-center">
                            ${prCount > 0 ? `<span class="text-xs font-mono bg-emerald-900/30 text-emerald-400 px-2 py-1 rounded border border-emerald-500/30 flex items-center gap-1"><i data-lucide="trending-up" class="w-3 h-3"></i>${prCount} PRs</span>` : ''}
                            <span class="text-xs font-mono bg-slate-800 px-2 py-1 rounded text-slate-300 border border-slate-700">${comp.events.length} Events</span>
                            <span class="text-xs font-mono bg-slate-800 px-2 py-1 rounded text-slate-300 border border-slate-700">${comp.solvesCount} Solves</span>
                        </div>
                    </div>
                    ${eventResultsHtml ? `<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mt-3">${eventResultsHtml}</div>` : ''}
                    ${prsHtml}
                </div>`;
        };


        const MedalTable = (medalStats) => {
            const rows = Object.entries(medalStats).sort(([a], [b]) => EVENT_ORDER.indexOf(a) - EVENT_ORDER.indexOf(b)).filter(([, stats]) => stats.total > 0).map(([event, stats]) => {
                const eventInfo = getEventInfo(event);
                return `<tr class="hover:bg-slate-800/50 transition-colors"><td class="px-4 py-3 font-medium text-white flex items-center gap-2"><div class="w-2 h-2 rounded-full ${eventInfo.bg}"></div>${eventInfo.name}</td><td class="px-4 py-3 text-center font-bold text-yellow-500">${stats.gold || "-"}</td><td class="px-4 py-3 text-center font-bold text-gray-400">${stats.silver || "-"}</td><td class="px-4 py-3 text-center font-bold text-amber-700">${stats.bronze || "-"}</td><td class="px-4 py-3 text-right font-bold text-white">${stats.total}</td></tr>`;
            }).join('');
            return `<div class="overflow-hidden rounded-xl border border-slate-800"><table class="w-full text-left bg-slate-900"><thead class="bg-slate-950 text-slate-400 text-xs uppercase font-semibold"><tr><th class="px-4 py-3">Event</th><th class="px-4 py-3 text-center text-yellow-500">Gold</th><th class="px-4 py-3 text-center text-gray-400">Silver</th><th class="px-4 py-3 text-center text-amber-700">Bronze</th><th class="px-4 py-3 text-right">Total</th></tr></thead><tbody class="divide-y divide-slate-800 text-sm">${rows}</tbody></table></div>`;
        };
        
        const RecordTable = (records, title, isAllTime, type, historicalPB = {}) => {
            if (!records || !records.single) return '';
            const events = Object.keys(records.single).sort((a, b) => EVENT_ORDER.indexOf(a) - EVENT_ORDER.indexOf(b));
            const rows = events.map((event) => {
                const recordSingle = records.single[event];
                const recordAvg = records.average[event];
                const historicalPBSingle = historicalPB.single?.[event]?.value || null;
                const historicalPBAvg = historicalPB.average?.[event]?.value || null;
                const isNewPBSingle = !isAllTime && historicalPBSingle !== null && recordSingle && recordSingle.value < historicalPBSingle;
                const isNewPBAvg = !isAllTime && historicalPBAvg !== null && recordAvg && recordAvg.value < historicalPBAvg;
                return `<tr class="hover:bg-slate-800/50 transition-colors"><td class="px-6 py-4 font-medium text-white flex items-center gap-2">${getEventInfo(event).name}</td><td class="px-6 py-4 border-r border-slate-800/50"><div class="font-mono text-indigo-300 font-bold">${recordSingle ? formatResult(recordSingle.value, event, 'single') : "-"} ${isNewPBSingle ? '<i data-lucide="award" class="w-3 h-3 text-yellow-400 ml-1"></i>' : ''}</div><div class="text-xs text-slate-500 truncate max-w-[250px]">${recordSingle?.comp || ""}</div></td><td class="px-6 py-4"><div class="font-mono text-white font-bold">${recordAvg ? formatResult(recordAvg.value, event, 'average') : "-"} ${isNewPBAvg ? '<i data-lucide="award" class="w-3 h-3 text-yellow-400 ml-1"></i>' : ''}</div><div class="text-xs text-slate-500 truncate max-w-[250px]">${recordAvg?.comp || ""}</div></td></tr>`;
            }).join('');
            if (rows === '') return `<div class="p-12 text-center text-slate-500 bg-slate-900 border border-slate-800 rounded-xl border-dashed"><i data-lucide="alert-circle" class="mx-auto mb-2 opacity-20 w-12 h-12"></i>No records found in this selection.</div>`;
            return `<div class="mb-10"><h4 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">${title}</h4><div class="overflow-x-auto rounded-xl border border-slate-800"><table class="w-full text-left bg-slate-900"><thead class="bg-slate-950 text-slate-400 text-xs uppercase font-semibold"><tr><th class="px-6 py-4">Event</th><th class="px-6 py-4 text-indigo-300">Single</th><th class="px-6 py-4 text-white">Average</th></tr></thead><tbody class="divide-y divide-slate-800">${rows}</tbody></table></div></div>`;
        }
        
        const SolveCountTable = (solveCounts, attemptCounts) => {
            const items = Object.entries(solveCounts)
                .sort(([a], [b]) => EVENT_ORDER.indexOf(a) - EVENT_ORDER.indexOf(b))
                .filter(([, c]) => c > 0)
                .map(([event, count]) => {
                    const e = getEventInfo(event);
                    const attempts = attemptCounts[event] || 0;
                    const isSelected = window.state.selectedEvent === event;
                    
                    return `
                        <div class="bg-slate-800 p-4 rounded-xl border ${isSelected ? 'border-indigo-500 bg-slate-800/80 ring-2 ring-indigo-500/20' : 'border-slate-700 hover:border-slate-500'} flex items-center gap-3 cursor-pointer transition-all active:scale-95"
                             onclick="window.setState({ selectedEvent: '${event}' }); document.getElementById('record-timeline').scrollIntoView({behavior:'smooth'})">
                            <div class="p-2 rounded-full ${e.bg} bg-opacity-80">
                                <i data-lucide="cuboid" class="w-5 h-5 text-slate-900"></i>
                            </div>
                            <div>
                                <div class="text-slate-400 text-xs uppercase font-bold">${e.name}</div>
                                <div class="text-lg font-mono font-bold text-white">
                                    <span class="text-indigo-300">${count}</span><span class="text-slate-500 text-sm">/${attempts}</span>
                                </div>
                            </div>
                        </div>`;
                }).join('');
        
            return `<div class="mb-12"><div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">${items}</div></div>`;
        };
        
        const TimelineView = (timeline, selectedEvent) => {
             const keys = Object.keys(timeline).sort((a, b) => EVENT_ORDER.indexOf(a) - EVENT_ORDER.indexOf(b));
             const filteredKeys = selectedEvent ? keys.filter(k => k === selectedEvent) : keys;
             
             if (filteredKeys.length === 0) return `<div class="p-10 text-center text-slate-500 border border-slate-800 rounded-xl border-dashed">No record updates for the selected criteria.</div>`;

             const sections = filteredKeys.map(event => {
                    const eventInfo = getEventInfo(event);
                    const records = timeline[event].reverse();
                    
                    const rows = records.map(rec => `
                        <tr class="hover:bg-slate-800/50 transition-colors border-l-2 ${rec.type === 'Average' ? 'border-indigo-500' : 'border-emerald-500'}">
                             <td class="px-4 py-3 text-slate-300 text-xs whitespace-nowrap">${rec.date}</td>
                             <td class="px-4 py-3 text-white font-medium">
                                ${rec.compName}
                                <div class="text-xs text-slate-500 font-normal">${rec.round}</div>
                             </td>
                             <td class="px-4 py-3">
                                <span class="px-2 py-0.5 rounded text-xs font-bold ${rec.type === 'Average' ? 'bg-indigo-900/50 text-indigo-300' : 'bg-emerald-900/50 text-emerald-300'}">
                                    ${rec.type}
                                </span>
                             </td>
                             <td class="px-4 py-3 font-mono font-bold text-white whitespace-nowrap">
                                ${rec.formattedResult}
                                ${rec.details ? `<div class="text-xs text-slate-500 font-normal mt-0.5">${rec.details}</div>` : ''}
                             </td>
                        </tr>
                    `).join('');

                    return `
                        <div class="mb-8 break-inside-avoid">
                            <h4 class="text-md font-bold text-white mb-3 flex items-center gap-2 border-b border-slate-800 pb-2">
                                <div class="w-2 h-2 rounded-full ${eventInfo.bg}"></div>
                                ${eventInfo.name}
                            </h4>
                            <div class="overflow-x-auto rounded-lg border border-slate-800">
                                <table class="w-full text-left bg-slate-900">
                                    <thead class="bg-slate-950 text-slate-400 text-xs uppercase font-semibold">
                                        <tr>
                                            <th class="px-4 py-2 w-24">Date</th>
                                            <th class="px-4 py-2">Competition</th>
                                            <th class="px-4 py-2 w-20">Type</th>
                                            <th class="px-4 py-2">Result</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-800 text-sm">${rows}</tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }).join('');
            
            return `<div class="space-y-6">${sections}</div>`;
        };

        // --- MAIN RENDER FUNCTION ---
        const renderApp = () => {
            const { userData, loading, error, historyData, selectedYear, activeTab, viewMode, compMetadata, loadingMetadata, selectedEvent } = window.state;
            const isAllTime = selectedYear === 'All Time';
            
            let stats = null;
            let currentTotalMedals = 0;
            let prevTotalMedals = null;
            
            if (userData && historyData) {
                stats = calculateStats(window.state);
                if (!loading && !error && !window.state.metadataFetchInProgress) {
                    if (stats.statsComps.length > 0) {
                        const ids = stats.statsComps.map(c => c.id);
                        fetchCompDetails(ids);
                    }
                }
                
                currentTotalMedals = stats.medals.gold + stats.medals.silver + stats.medals.bronze;
                prevTotalMedals = stats.prevStats?.medals ? (stats.prevStats.medals.gold + stats.prevStats.medals.silver + stats.prevStats.medals.bronze) : null;
            }

            const appHtml = `
                <header class="bg-slate-950 border-b border-slate-800 sticky top-0 z-20">
                    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between gap-4">
                        <div class="flex items-center gap-6 shrink-0">
                            <div class="flex items-center gap-3">
                                <div class="bg-indigo-600 p-2 rounded-lg"><i data-lucide="cuboid" class="text-white w-5 h-5"></i></div>
                                <h1 class="text-xl font-bold hidden sm:block bg-gradient-to-r from-white to-slate-400 bg-clip-text text-transparent">CuberWCASummary</h1>
                            </div>
                            
                            <!-- Main Navigation -->
                            <div class="flex items-center bg-slate-900/50 p-1 rounded-lg border border-slate-800">
                                <button onclick="window.setState({ viewMode: 'profile' })" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all ${viewMode === 'profile' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}">Profile</button>
                                <button onclick="window.setState({ viewMode: 'leaderboard', selectedYear: 'All Time' })" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all ${viewMode === 'leaderboard' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}">Leaderboard</button>
                            </div>
                        </div>
                        
                        ${viewMode === 'profile' ? `
                        <form id="searchForm" class="flex-1 max-w-md relative ml-auto">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 w-4 h-4"></i>
                            <input type="text" id="wcaSearchInput" placeholder="Enter WCA ID (e.g., 2017KWAN05)" class="w-full bg-slate-900 border border-slate-700 rounded-full py-2 pl-10 pr-4 text-sm text-white placeholder:text-slate-600 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all" value="${window.state.inputWcaId}" />
                        </form>
                        ` : '<div class="flex-1"></div>'}
                    </div>
                </header>

                <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    ${viewMode === 'leaderboard' ? `
                        ${Top200Modal()}
                        ${LeaderboardView()}
                    ` : `
                        <!-- Profile View -->
                        ${loading ? `<div class="flex flex-col items-center justify-center py-20 text-indigo-400"><i data-lucide="loader-2" class="animate-spin mb-4 w-12 h-12"></i><p>Fetching WCA Data...</p></div>` 
                        : error ? `<div class="flex flex-col items-center justify-center py-20 text-red-400"><i data-lucide="alert-circle" class="mb-4 w-12 h-12"></i><p class="text-lg font-bold">Error Loading Data</p><p class="text-sm opacity-80">${error}</p><p class="text-xs mt-4 text-slate-500">Check WCA ID.</p></div>` 
                        : !userData ? `<div class="text-center py-20 text-slate-500"><p>No data available. Use the search bar to load a WCA ID.</p></div>` 
                        : `
                            <div class="flex overflow-x-auto pb-4 mb-6 gap-2 no-scrollbar border-b border-slate-800/50">
                                <button onclick="window.setState({ selectedYear: 'All Time', selectedEvent: null })" class="px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all border ${selectedYear === 'All Time' ? 'bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/20' : 'bg-slate-800 text-slate-400 border-slate-700 hover:text-white hover:border-slate-600'}">All Time</button>
                                ${historyData.map(h => `<button onclick="window.setState({ selectedYear: '${h.year}', selectedEvent: null })" class="px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all border ${selectedYear === String(h.year) ? 'bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/20' : 'bg-slate-800 text-slate-400 border-slate-700 hover:text-white hover:border-slate-600'}">${h.year}</button>`).join('')}
                            </div>

                            <div class="flex flex-col md:flex-row items-center md:items-start gap-6 mb-10">
                                <img src="https://flagcdn.com/w160/${userData.country.toLowerCase()}.png" alt="${userData.country} Flag" class="w-20 h-20 rounded-full border-4 border-slate-800 shadow-xl bg-slate-700 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/80x80/1f2937/6b7280?text=${userData.country}';" />
                                <div class="text-center md:text-left flex-1">
                                    <h2 class="text-3xl font-bold text-white">${userData.name}</h2>
                                    <div class="flex items-center justify-center md:justify-start gap-3 mt-2 text-slate-400">
                                    <span class="flex items-center gap-1 text-sm bg-slate-800 px-2 py-0.5 rounded border border-slate-700"><i data-lucide="hash" class="w-3 h-3"></i> ${userData.wcaId}</span>
                                    <span class="flex items-center gap-1 text-sm bg-slate-800 px-2 py-0.5 rounded border border-slate-700"><i data-lucide="globe" class="w-3 h-3"></i> ${userData.country}</span>
                                    </div>
                                    <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 bg-slate-900/50 p-4 rounded-lg border border-slate-800/50">
                                        <div class="text-center md:text-left"><div class="text-xs text-slate-500 uppercase">Total Attempts</div><div class="text-white font-mono font-bold flex items-center justify-center md:justify-start gap-2">${stats.totalAttempts} ${TrendIndicator(stats.totalAttempts, stats.prevStats?.totalAttempts)}</div></div>
                                        <div class="text-center md:text-left"><div class="text-xs text-slate-500 uppercase">Success Rate</div><div class="text-indigo-400 font-mono font-bold">${stats.totalAttempts > 0 ? ((stats.totalSolves / stats.totalAttempts) * 100).toFixed(1) : 0}%</div></div>
                                        <div class="text-center md:text-left"><div class="text-xs text-slate-500 uppercase">Countries Visited</div><div class="text-white font-mono font-bold flex items-center justify-center md:justify-start gap-2">${stats.uniqueCountries} ${loadingMetadata ? `<i data-lucide="loader-2" class="animate-spin w-2.5 h-2.5"></i>` : ''} ${TrendIndicator(stats.uniqueCountries, stats.prevStats?.uniqueCountries)}</div></div>
                                        <div class="text-center md:text-left"><div class="text-xs text-slate-500 uppercase">Overseas Comps</div><div class="text-white font-mono font-bold flex items-center justify-center md:justify-start gap-2">${stats.overseasCount} ${TrendIndicator(stats.overseasCount, stats.prevStats?.overseasCount)}</div></div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                                ${StatCard({ title: "Competitions", value: stats.totalComps, trendHtml: TrendIndicator(stats.totalComps, stats.prevStats?.totalComps), icon: "calendar", colorClass: "text-blue-400 bg-blue-400/10" })}
                                ${StatCard({ title: "Total Solves", value: stats.totalSolves, trendHtml: TrendIndicator(stats.totalSolves, stats.prevStats?.totalSolves), icon: "activity", colorClass: "text-emerald-400 bg-emerald-400/10" })}
                                ${StatCard({ title: "Total PRs", value: stats.totalPRs, trendHtml: TrendIndicator(stats.totalPRs, stats.prevTotalPRs), icon: "trending-up", colorClass: "text-purple-400 bg-purple-400/10" })}
                                ${StatCard({ title: "Total Medals", value: currentTotalMedals, subtext: `${stats.medals.gold} Gold, ${stats.medals.silver} Silver, ${stats.medals.bronze} Bronze`, trendHtml: TrendIndicator(currentTotalMedals, prevTotalMedals), icon: "trophy", colorClass: "text-yellow-400 bg-yellow-400/10" })}
                            </div>

                            <div class="border-b border-slate-800 mb-8">
                                <nav class="flex overflow-x-auto space-x-8 pb-1 no-scrollbar">
                                    ${['overview', 'competitions', 'records', 'solves'].map((tab) => `<button onclick="window.setState({ activeTab: '${tab}' })" class="pb-4 text-sm font-medium border-b-2 transition-colors capitalize ${activeTab === tab ? 'border-indigo-500 text-indigo-400' : 'border-transparent text-slate-400 hover:text-slate-300 hover:border-slate-700'}">${tab.replace('_', ' ')}</button>`).join('')}
                                </nav>
                            </div>

                            <div class="animate-fade-in-up">
                                ${activeTab === 'overview' ? `
                                    <div>
                                        <h3 class="text-xl font-bold text-white flex items-center gap-2 mb-6"><i data-lucide="medal" class="text-indigo-400 w-5 h-5"></i> Medal Breakdown (Final Rounds)</h3>
                                        ${Object.keys(stats.medalStats).length > 0 ? MedalTable(stats.medalStats) : `<div class="p-12 text-center text-slate-500 bg-slate-900 border border-slate-800 rounded-xl border-dashed"><i data-lucide="trophy" class="mx-auto mb-2 opacity-20 w-12 h-12"></i>No podiums found in this selection.</div>`}
                                        ${isAllTime ? StatsSection(stats.annualStats) : ''}
                                    </div>
                                ` : activeTab === 'competitions' ? `
                                    <div class="space-y-6">
                                        <div class="flex justify-between items-center"><h3 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="list-checks" class="text-indigo-400 w-5 h-5"></i>Full Competition Results (Podiums & PRs)</h3>${loadingMetadata ? `<span class="text-xs text-indigo-400 flex items-center gap-1"><i data-lucide="loader-2" class="animate-spin w-3 h-3"></i> Loading Locations...</span>` : ''}</div>
                                        <div class="bg-slate-950 p-6 rounded-xl border border-slate-800">
                                            ${stats.statsComps.length > 0 ? stats.statsComps.sort((a, b) => { const dateA = window.state.compMetadata[a.id]?.date?.from || a.id; const dateB = window.state.compMetadata[b.id]?.date?.from || b.id; return dateB.localeCompare(dateA); }).map(comp => CompetitionItem(comp, stats.prCounts[comp.id] || 0, stats.prsByComp[comp.id])).join('') : `<div class="p-12 text-center text-slate-500 bg-slate-900 border border-slate-800 rounded-xl border-dashed"><i data-lucide="calendar" class="mx-auto mb-2 opacity-20 w-12 h-12"></i>No competitions found in this year.</div>`}
                                        </div>
                                    </div>
                                ` : activeTab === 'records' ? `
                                    <div>
                                        <h3 class="text-2xl font-bold text-white mb-8 flex items-center gap-2"><i data-lucide="timer" class="text-indigo-400 w-6 h-6"></i> Personal Records</h3>
                                        ${!stats.totalComps ? `<div class="p-12 text-center text-slate-500 bg-slate-900 border border-slate-800 rounded-xl border-dashed"><i data-lucide="alert-circle" class="mx-auto mb-2 opacity-20 w-12 h-12"></i>No competition data for this period.</div>` : selectedYear === 'All Time' ? `${RecordTable(stats.pb, "All-Time Personal Records (PRs)", true, 'pb')}` : `${RecordTable(stats.sb, `Best Results in ${selectedYear}`, false, 'sb', stats.pb)}${RecordTable(stats.pb, `All-Time Personal Records (PRs) Up To ${selectedYear}`, false, 'pb')}`}
                                    </div>
                                ` : activeTab === 'solves' ? `
                                    <div>
                                        <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-2"><i data-lucide="layers" class="text-indigo-400 w-6 h-6"></i> Solve Analysis (Graph and Timeline)</h3>
                                        <p class="text-slate-400 text-sm mb-6">Click the event button to learn your progression!</p>
                                        ${SolveCountTable(stats.solveCounts, stats.attemptCounts)}
                                        
                                        ${selectedEvent ? `
                                            <div class="mb-10 animate-fade-in-up">
                                                <div class="flex items-center justify-between mb-4">
                                                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                                        <i data-lucide="line-chart" class="text-indigo-400 w-5 h-5"></i> 
                                                        ${getEventInfo(selectedEvent).name} Progress
                                                    </h3>
                                                    <div class="text-xs text-slate-500">Excludes DNF/DNS</div>
                                                </div>
                                                <div class="bg-slate-950 p-4 rounded-xl border border-slate-800 h-[600px] relative">
                                                    <canvas id="solvesChart"></canvas>
                                                </div>
                                            </div>
                                        ` : ''}

                                        <h3 id="record-timeline" class="text-2xl font-bold text-white mb-8 flex items-center gap-2">
                                            <i data-lucide="trending-up" class="text-emerald-400 w-6 h-6"></i>
                                            ${selectedEvent ? `${getEventInfo(selectedEvent).name} Record Timeline` : 'Record Timeline'}
                                        </h3>
                                        ${TimelineView(stats.timeline, selectedEvent)}
                                    </div>
                                ` : ''}
                            </div>
                        `}
                    `}
                </main>
            `;
            
            APP_ROOT.innerHTML = appHtml;
            updateIcons();
            
            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                searchForm.onsubmit = window.handleSearch;
            }

            if (viewMode === 'profile' && stats) {
                if (activeTab === 'solves' && selectedEvent) {
                    setTimeout(() => renderSolvesChart(stats.statsComps, selectedEvent), 50);
                }

                if (activeTab === 'overview' && isAllTime && stats.annualStats) {
                    setTimeout(() => renderStatsCharts(stats.annualStats), 50);
                }
            }
        };

        window.openProfile = (id) => {
            window.setState({ viewMode: 'profile', wcaId: id, selectedEvent: null });
            fetchData(id);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.addEventListener('load', () => {
            renderApp(); 
            fetchData(window.state.wcaId);
        });
        
        document.addEventListener('input', e => {
            if (e.target.id === 'wcaSearchInput') {
                e.target.value = e.target.value.toUpperCase();
                window.state.inputWcaId = e.target.value;
            }
        });

    </script>
</body>
</html>
